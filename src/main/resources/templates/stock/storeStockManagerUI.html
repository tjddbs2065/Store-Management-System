<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>재고 변동 조회 : 본사</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        /* ===== 페이지 스코프 ===== */
        .erp-stock-history{ --ctl-h:31px; --ctl-font:.95rem; --brand:#FFEEAA; --brand-hover:#f2da84; }
        .erp-stock-history body{ background:#f8f9fa; }
        .erp-stock-history .layout-container{ max-width:1500px; margin:0 auto; }

        /* 컨트롤 통일 */
        .erp-stock-history :where(.ctl .form-control, .ctl .form-select, .ctl .btn){ height:var(--ctl-h); font-size:var(--ctl-font); }
        .erp-stock-history :where(.input-group-sm > .form-control, .input-group-sm > .btn){ height:var(--ctl-h); }
        .erp-stock-history .w-compact{ max-width:220px; }
        .erp-stock-history .w-compact-lg{ max-width:320px; }
        .erp-stock-history .w-220{ width:220px; }
        @media (max-width:576px){ .erp-stock-history .w-220{ width:180px; } }

        /* 버튼 */
        .erp-stock-history .btn-main{ background:var(--brand); border-color:var(--brand); color:#000; }
        .erp-stock-history .btn-main:hover{ background:var(--brand-hover); border-color:var(--brand-hover); color:#000; }

        /* 테이블 */
        .erp-stock-history table.stock-table thead{ background:#e9ecef !important; }
        .erp-stock-history table.stock-table th{ color:#212529 !important; }
        .erp-stock-history table.stock-table td, .erp-stock-history table.stock-table th{ font-size:.9rem; }
        .erp-stock-history table.stock-table tbody tr{ background:#fff !important; }
        .erp-stock-history table.stock-table tbody tr:nth-of-type(odd),
        .erp-stock-history table.stock-table tbody tr:nth-of-type(even){ background:#fff !important; }

        /* + / - */
        .erp-stock-history td.text-end.chg-plus{ color:#0d6efd !important; font-weight:700; }
        .erp-stock-history td.text-end.chg-minus{ color:#dc3545 !important; font-weight:700; }

        /* 결과 카드 & 오버레이 */
        .erp-stock-history .result-card{ position:relative !important; }
        .erp-stock-history #storeNoticeOverlay{
            position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            background:rgba(255,255,255,.6); backdrop-filter:blur(3px); z-index:5;
        }
        .erp-stock-history #storeNoticeOverlay .overlay-card{
            text-align:center; background:#ffffffdd; padding:28px 36px; border-radius:12px;
            box-shadow:0 4px 14px rgba(0,0,0,.12);
        }

        .erp-stock-history .pagination{ margin-top:16px; margin-bottom:0; }

        /* 모달 프리페치 가림막 */
        .erp-stock-history #storeSearchModal .modal-body._hideUntilReady{ visibility:hidden; }
    </style>
</head>
<body class="erp-stock-history">
<header th:replace="fragments/toolBar :: toolBarManager"></header>

<div class="layout-container py-4 px-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="fw-bold mb-0">재고 변동 조회 : 본사</h3>
        <div class="d-flex align-items-center gap-2 ctl">
            <span class="fw-semibold small">직영점</span>
            <input id="storeSearchKeyword" class="form-control form-control-sm w-220" placeholder="직영점명" />
            <button type="button" class="btn btn-sm btn-main px-3" id="btnOpenStoreSearch">검색</button>
        </div>
    </div>

    <!-- 조회영역 (2줄) -->
    <div class="card p-3 mb-3 shadow-sm border-0">
        <!-- 1줄: 기간 -->
        <div class="row g-2 align-items-end ctl mb-1">
            <div class="col-12 col-lg-6">
                <label class="fw-bold small d-block mb-1">기간</label>
                <div class="d-flex align-items-center gap-2">
                    <input type="date" id="dateFrom" class="form-control form-control-sm w-compact-lg" />
                    <span class="small">~</span>
                    <input type="date" id="dateTo" class="form-control form-control-sm w-compact-lg" />
                </div>
            </div>
            <div class="col d-none d-lg-block"></div>
        </div>

        <!-- 2줄: 카테고리/변동유형/조건/검색어 + 조회/초기화(오른쪽) -->
        <div class="row g-2 align-items-end ctl">
            <div class="col-6 col-md-2">
                <label class="fw-bold small d-block mb-1">카테고리</label>
                <select id="categorySelect" class="form-select form-select-sm">
                    <option value="">전체</option><option>도우</option><option>소스</option>
                    <option>치즈</option><option>육류</option><option>야채</option>
                    <option>사이드</option><option>음료</option>
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="fw-bold small d-block mb-1">변동유형</label>
                <select id="reasonSelect" class="form-select form-select-sm">
                    <option value="">전체</option>
                    <option value="입고">입고</option><option value="판매">판매</option>
                    <option value="폐기">폐기</option><option value="조정">조정</option>
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="fw-bold small d-block mb-1">조건</label>
                <select id="searchTypeSelect" class="form-select form-select-sm">
                    <option value="ITEM_NAME">품목명</option>
                    <option value="ITEM_CODE">품목코드</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <label class="fw-bold small d-block mb-1">검색어</label>
                <input id="searchKeyword" class="form-control form-control-sm w-100" placeholder="검색어 입력" />
            </div>
            <div class="col-12 col-md-3">
                <div class="d-flex gap-2 justify-content-md-end mt-2 mt-md-0">
                    <button class="btn btn-sm btn-main px-3" id="btnSearch">조회</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary px-3" id="btnReset">초기화</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 결과 -->
    <div class="card shadow-sm border-0 result-card">
        <div id="storeNoticeOverlay">
            <div class="overlay-card">
                <i class="bi bi-shop fs-1 mb-2"></i>
                <div class="fw-bold">먼저 직영점을 선택해주세요</div>
                <div class="text-muted small">변동 내역은 직영점 선택 후 확인할 수 있어요.</div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0 stock-table bg-white">
                    <thead>
                    <tr class="table-light">
                        <th>변동일시</th>
                        <th>카테고리</th>
                        <th>품목코드</th>
                        <th>품목명</th>
                        <th>변동유형</th>
                        <th class="text-end">변동수량</th>
                        <th class="text-end">현재 재고</th>
                        <th>폐기사유</th>
                    </tr>
                    </thead>
                    <tbody id="stockHistoryBody">
                    <!-- 데이터 바인딩 or 샘플 -->
                    <tr><td>2025-11-20 10:12</td><td>도우</td><td>DOUGH-M-230G</td><td>도우 M 230g(레귤러)</td><td>입고</td><td class="text-end">+50 ea</td><td class="text-end">120 ea</td><td>-</td></tr>
                    <tr><td>2025-11-20 18:40</td><td>도우</td><td>DOUGH-M-230G</td><td>도우 M 230g(레귤러)</td><td>판매</td><td class="text-end">-24 ea</td><td class="text-end">96 ea</td><td>-</td></tr>
                    <tr><td>2025-11-19 09:30</td><td>소스</td><td>SAUCE-3KG-CAN</td><td>토마토 소스 3kg 캔</td><td>입고</td><td class="text-end">+5 can</td><td class="text-end">18 can</td><td>-</td></tr>
                    <tr><td>2025-11-19 21:05</td><td>소스</td><td>SAUCE-3KG-CAN</td><td>토마토 소스 3kg 캔</td><td>폐기</td><td class="text-end">-1 can</td><td class="text-end">17 can</td><td>유통기한 경과</td></tr>
                    </tbody>
                </table>
            </div>

            <nav class="mt-3 mb-3">
                <ul class="pagination justify-content-center" id="pager"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- 모달 프래그먼트 -->
<div th:replace="fragments/modalStoreSearch :: modalStoreSearch"></div>
<div th:replace="fragments/modalLimit :: modalLimit"></div>
<div th:replace="fragments/modalDispose :: modalDispose"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* +/- 색 */
    function paintPlusMinus($root){
        $root.find("td.text-end").each(function(){
            const t=$(this).text().trim();
            $(this).removeClass("chg-plus chg-minus");
            if(/^\+/.test(t)) $(this).addClass("chg-plus");
            if(/^\-/.test(t)) $(this).addClass("chg-minus");
        });
    }

    /* 오버레이 */
    function applyStoreOverlay(){
        const v = $.trim($('#storeSearchKeyword').val());
        $('#storeNoticeOverlay').toggleClass('d-none', !!v);
    }

    /* 결과 페이징 */
    const ROWS_PER_PAGE=10;
    let $rows=$(), totalPages=1, currentPage=1;
    function buildPager(){
        $rows=$("#stockHistoryBody tr");
        totalPages=Math.max(1, Math.ceil($rows.length/ROWS_PER_PAGE));
        const $p=$("#pager").empty();
        const li=(d,t)=>$(`<li class="page-item"><a class="page-link" href="#" data-page="${d}">${t}</a></li>`);
        $p.append(li('first','«')).append(li('prev','‹'));
        for(let i=1;i<=totalPages;i++) $p.append(li(String(i), String(i)));
        $p.append(li('next','›')).append(li('last','»'));
    }
    function showPage(p){
        currentPage=p;
        $rows.addClass("d-none");
        const s=(p-1)*ROWS_PER_PAGE, e=s+ROWS_PER_PAGE;
        $rows.slice(s,e).removeClass("d-none");
        paintPlusMinus($("#stockHistoryBody"));
        paintPager();
    }
    function paintPager(){
        const $p=$("#pager");
        $p.find(".page-item").removeClass("active disabled");
        $p.find(`a[data-page="${currentPage}"]`).parent().addClass("active");
        if(currentPage===1){ dis('first'); dis('prev'); }
        if(currentPage===totalPages){ dis('last'); dis('next'); }
        function dis(k){ $p.find(`a[data-page="${k}"]`).parent().addClass("disabled"); }
    }
    $(document).on("click","#pager a.page-link",function(e){
        e.preventDefault();
        const act=$(this).data("page"); const $li=$(this).parent();
        if($li.hasClass("disabled")||$li.hasClass("active")) return;
        if(act==='first') showPage(1);
        else if(act==='prev') showPage(Math.max(1,currentPage-1));
        else if(act==='next') showPage(Math.min(totalPages,currentPage+1));
        else if(act==='last') showPage(totalPages);
        else{ const n=parseInt(act,10); if(!isNaN(n)) showPage(n); }
    });

    /* 직영점 검색 모달 */
    let storeSearchModalInstance=null;
    function prepareStoreModalFirstView(){
        $('#storeSearchModal .modal-body').addClass('_hideUntilReady');
        window._$allStoreRows=$('#storeSearchTableBody tr'); window._$allStoreRows.hide();
        const kw=$('#storeSearchInput').val()||'';
        window._$filteredStoreRows = kw ? window._$allStoreRows.filter(function(){
            return $(this).find('td').first().text().indexOf(kw)!==-1;
        }) : window._$allStoreRows;

        const PER=5; let total=Math.max(1, window._$filteredStoreRows.length);
        let totalPages=Math.max(1, Math.ceil(total/PER)); let cur=1;

        function renderPager(){
            const $p=$("#storeSearchPager").empty();
            const li=(d,t)=>$(`<li class="page-item"><a class="page-link" href="#" data-page="${d}">${t}</a></li>`);
            $p.append(li('first','«')).append(li('prev','‹'));
            for(let i=1;i<=totalPages;i++) $p.append(li(String(i), String(i)));
            $p.append(li('next','›')).append(li('last','»'));
            paint();
        }
        function paint(page){
            if(page) cur=page;
            window._$allStoreRows.hide();
            const s=(cur-1)*PER, e=s+PER;
            window._$filteredStoreRows.slice(s,e).show();
            const $p=$("#storeSearchPager");
            $p.find(".page-item").removeClass("active disabled");
            $p.find(`a[data-page="${cur}"]`).parent().addClass("active");
            if(cur===1){ dis('first'); dis('prev'); }
            if(cur===totalPages){ dis('last'); dis('next'); }
            function dis(k){ $p.find(`a[data-page="${k}"]`).parent().addClass("disabled"); }
        }
        renderPager();
        $(document).off('click._storePager').on('click._storePager','#storeSearchPager a.page-link',function(e){
            e.preventDefault();
            const act=$(this).data('page'); const $li=$(this).parent();
            if($li.hasClass('disabled')||$li.hasClass('active')) return;
            if(act==='first') paint(1);
            else if(act==='prev') paint(Math.max(1,cur-1));
            else if(act==='next') paint(Math.min(totalPages,cur+1));
            else if(act==='last') paint(totalPages);
            else{ const n=parseInt(act,10); if(!isNaN(n)) paint(n); }
        });

        requestAnimationFrame(()=> $('#storeSearchModal .modal-body').removeClass('_hideUntilReady'));
    }

    $('#btnOpenStoreSearch').on('click', function(){
        if(!storeSearchModalInstance){
            storeSearchModalInstance=new bootstrap.Modal(document.getElementById('storeSearchModal'));
        }
        $('#storeSearchInput').val($('#storeSearchKeyword').val()||'');
        prepareStoreModalFirstView();
        storeSearchModalInstance.show();
    });

    $(document).on('click','#btnSearchStoreExec',function(){ prepareStoreModalFirstView(); });
    $(document).on('click','#btnSearchStoreReset',function(){ $('#storeSearchInput').val(''); prepareStoreModalFirstView(); });
    $(document).on('click','#btnStoreAll',function(){
        $('#storeSearchKeyword').val('전체 직영점').trigger('input');
        applyStoreOverlay(); storeSearchModalInstance?.hide();
    });
    $(document).on('click','.btn-select-store',function(){
        $('#storeSearchKeyword').val($(this).data('store')||'').trigger('input');
        applyStoreOverlay(); storeSearchModalInstance?.hide();
    });

    /* 초기화 */
    $(function(){
        buildPager(); showPage(1);
        applyStoreOverlay();

        $('#btnSearch').on('click', function(){ /* 서버 연동 지점 */ });
        $('#btnReset').on('click', function(){
            $('#dateFrom,#dateTo').val('');
            $('#categorySelect,#reasonSelect').val('');
            $('#searchTypeSelect').val('ITEM_NAME');
            $('#searchKeyword').val('');
        });
        $('#storeSearchKeyword').on('input change', applyStoreOverlay);
    });
</script>
</body>
</html>
