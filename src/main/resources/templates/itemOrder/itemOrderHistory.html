<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>발주 내역</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
 body { background:#f8f9fa; font-family:"Noto Sans KR",sans-serif;
   max-width: 1500px;}


 table{
   table-layout: fixed;
 }
 .card-box { background:#fff; border-radius:12px; padding:20px; border:1px solid #dee2e6;}
 .table thead { background:#e9ecef; font-weight:600;}
</style>
</head>
<body class="p-4">

<h3 class="fw-bold mb-4">발주 내역</h3>

<div class="card-box mb-4">

 <div class="row g-3 mb-3">
   <div class="col-auto">
     <input type="date" class="form-control">
   </div>
   <div class="col-auto">
     <input type="date" class="form-control">
   </div>
   <div class="col-auto d-flex align-items-center">
     <select class="form-select">
       <option value="">요일 전체</option>
       <option>월</option><option>화</option><option>수</option>
       <option>목</option><option>금</option><option>토</option><option>일</option>
     </select>
   </div>
   <div class="col-auto">
     <select class="form-select">
       <option>전체</option><option>대기</option><option>승인</option><option>취소</option>
     </select>
   </div>
   <div class="col-auto">
     <button class="btn btn-dark" id="view-btn">조회</button>
   </div>
 </div>

 <table class="table table-bordered align-middle text-center" id="item_order_list">
   <thead>
     <tr>
       <th>요청번호</th><th>직영점</th><th>요청일자</th><th>요일</th>
       <th>요청시각</th><th>품목수</th><th>발주액</th><th>발주상태</th><th>입고상태</th><th>처리</th>
     </tr>
   </thead>
   <tbody>
   </tbody>
 </table>

  <!-- ▼ 페이지네이션 추가 -->
  <nav>
    <ul class="pagination justify-content-center" id="pagination">
      <li class="page-item disabled">
        <a class="page-link" data-page="prev">이전</a>
      </li>
      <li class="page-item active">
        <a class="page-link" data-page="1">1</a>
      </li>
      <li class="page-item">
        <a class="page-link" data-page="next">다음</a>
      </li>
    </ul>
  </nav>
  <!-- ▲ 페이지네이션 끝 -->

</div>

<!-- 발주 상세 보기 모달 -->
<div class="modal fade details-modal" id="orderItemDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header" style="background:#f8f8f8;">
        <h5 class="modal-title fw-bold">발주 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <h5 class="fw-bold mb-3" id="order-no">[R-2025-1191]</h5>

        <div class="mb-2">
          <span class="me-4" id="store-name_modal">직영점 : 가산점</span>
          <span class="badge bg-warning text-dark" id="order-status-modal">승인</span>
        </div>

        <div class="mb-4" id="order-date-modal">요청일자 : 2025-11-09(일) 23 : 22</div>

        <table class="table table-bordered align-middle text-center">
          <thead style="background:#f1f1f1;font-weight:600;">
          <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>카테고리</th>
            <th>발주 수량(기준 단위)</th>
            <th>공급가격</th>
            <th>발주액</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="d-flex justify-content-between mt-3">
          <div>품목수 : <strong>2 개</strong></div>
          <div>총 발주액 : <strong>164,000 원</strong></div>
        </div>
      </div>

      <div class="modal-footer" id="action-btn">
      </div>

    </div>
  </div>
</div>

<script type="application/javascript" src="/js/util.js"></script>
<script>
  const itemOrderTable = $("#item_order_list");

  function loadPage(pageNo) {
    fetchUtil(`/itemOrder/itemOrderList/${pageNo - 1}`, data => {
      loadItemOrderTable(data);
      updatePaginationUI(data.pageNo, data.totalPages);
    });
  }

  // 발주 상세 조회
  function loadItemOrderDetail(data) {
    const thead = $("#orderItemDetailModal thead");
    thead.empty();
    const tbody = $("#orderItemDetailModal tbody");
    tbody.empty();
    const footer = $("#action-btn");
    footer.empty();

    const orderStatus = selectedRow.find("td").eq(7).text(); // 발주 상태
    const receiveStatus = selectedRow.find("td").eq(8).text(); // 입고 상태

    $("#order-no").text("#" + selectedRow.find("td").eq(0).text());
    $("#store-name_modal").text(selectedRow.find("td").eq(1).text());
    $("#order-status-modal").text(orderStatus);
    $("#order-date-modal").text("요청일자:  " + selectedRow.find("td").eq(2).text() + "(" +selectedRow.find("td").eq(3).text() + ") " + selectedRow.find("td").eq(4).text());


    // 입고 대기 상태 시 추가
    let header = `
          <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>카테고리</th>
            <th>발주 수량(기준 단위)</th>
            <th>공급가격</th>
            <th>발주액</th>`;
    if(receiveStatus === "입고대기")
      header += `<th>입고상태</th>`;
    header += `</tr>`;
    thead.append(header);

    // body 설정
    data.forEach(item => {
      let row = `
          <tr>
            <td>${item.itemCode}</td>
            <td class="fw-bold">${item.itemName}</td>
            <td>${item.itemCategoryName}</td>
            <td>${item.itemOrderQuantity} ${item.supplyUnit}</td>
            <td>${item.itemPrice}</td>
            <td>${item.itemOrderPrice}</td>`;
      if(receiveStatus === "입고대기") {
        if (item.receiveDatetime != null)
          row += `<td><button class="btn btn-outline-secondary btn-sm">입고완료</button></td>`;
        else
          row += `<td><button class="btn btn-outline-warning btn-sm">입고</button></td>`;
      }
      row += `</tr>`;
      tbody.append(row);
    });

    // 상태 별 처리 버튼 추가
    if(orderStatus === "대기"){
      footer.append(`<button class="btn btn-danger req_cancel_btn">요청 취소</button>`);
    }
    else if(receiveStatus === "입고대기"){
      footer.append(`<button class="btn btn-outline-secondary receive_all_btn">전체 입고처리</button>`);
    }

  }


  // 발주 목록 조회
  const days = ["일", "월", "화", "수", "목", "금", "토"];
  function loadItemOrderTable(data) {
    const tbody = itemOrderTable.find("tbody");
    tbody.empty();

    data.list.forEach(item => {
      const date = new Date(item.requestDate);
      let row = `
              <tr>
                  <td data-orderno="${item.itemOrderNo}">${item.itemOrderNo}</td>
                  <td>${item.storeName}</td>
                  <td>${"" + date.getFullYear() + "-" + String(date.getMonth() + 1).padStart(2, "0") + "-" + String(date.getDate()).padStart(2, "0")}</td>
                  <td>${days[date.getDay()]}</td>
                  <td>${String(date.getHours()).padStart(2, "0") + " : " + String(date.getMinutes()).padStart(2, "0")}</td>
                  <td>${item.quantity}</td>
                  <td>${item.price.toLocaleString()} 원</td>
                  <td style="color: green;" class="req_status">${item.orderStatus}</td>
          `;
      // 발주 요청 상태
      if(item.orderStatus === "승인") row += `<td class="receive_status">${item.receiveStatus}</td>`;
      else row += `<td></td>`;

      row += `<td><button class="btn btn-outline-secondary btn-sm detail_btn" data-bs-toggle="modal" data-bs-target="#orderItemDetailModal">상세조회</button></td>`;

      tbody.append(row + "</tr>");
    });
  }

  $(window).on("load", function () {
    loadPage(1);
  });

  function getItemOrderDetail(itemOrderNo){
    fetchUtil(`/itemOrder/itemOrderDetail/${itemOrderNo}`, (data)=>{
      loadItemOrderDetail(data);
    });
  }

  let selectedRow = null;
  $(document).on("click", ".detail_btn", function(){
    selectedRow = $(this).closest("tr");
    getItemOrderDetail(selectedRow.find("td").data("orderno"));
  });

  function cancelItemOrder(itemOrderNo){
    fetchUtil(`/itemOrder/cancelItemOrder/${itemOrderNo}`, (data)=>{
      console.log(data);
      selectedRow.find(".req_status").text("취소");
      document.activeElement.blur();   // 포커스 제거
      $("#orderDetailCancelModal").modal("hide");
    }, "PUT");
  }

  // 클릭 시 주문 상태 상태 변경
  $(document).on("click", ".req_cancel_btn", function(){
    cancelItemOrder(selectedRow.find("td").data("orderno"));
  });

  // 클릭 시 주문 입고 상태 변경
  $("#receive_all_btn").on("click", function(){
    selectedRow.find(".receive_status").text("입고완료");
    document.activeElement.blur();   // 포커스 제거
    $("#orderDetailModal").modal("hide");
  });

  // 클릭 시 조건 검색
  $(document).on("click", "#view-btn", function(){

  });

</script>
</body>
</html>
