<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<title>발주 내역</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="application/javascript" src="/js/util.js"></script>
<style>
 body {
   height: 100vh;
   display: flex;
   flex-direction: column;
   margin: 0;

   background:#f8f9fa;
   font-family:"Noto Sans KR",sans-serif;
   padding: 0;
 }
 h3{
   margin: 0;
   padding: 20px 20px 0 20px;
 }
 .p-4 {
    flex: 1;
    overflow: auto; /* 내용 많아지면 스크롤 생김 */
  }

 #content-area{
   flex: 1;
   display: flex;
   flex-direction: column;
   overflow: hidden;
   min-width: 1500px;
 }

 table{
   table-layout: fixed;
 }
 tr{
     height: 50px;
 }
 .card-box {
     flex: 1;
     background:#fff;
     border-radius:12px;
     padding:20px;
     border:1px solid #dee2e6;
     margin: 20px;
   }
 .table thead { background:#e9ecef; font-weight:600;}
</style>
</head>
<body>

<header th:replace="fragments/toolBar :: toolBar"></header>
<div class="container" id="content-area">

<h3 class="fw-bold">발주 내역</h3>
<div class="card-box mb-4 d-flex flex-column">

 <div class="row g-3 mb-3">
   <div class="col-auto">
     <input type="date" class="form-control" id="start-date">
   </div>
   <div class="col-auto">
     <input type="date" class="form-control" id="end-date">
   </div>
   <div class="col-auto">
     <select class="form-select" id="order-status">
       <option>전체</option><option>대기</option><option>승인</option><option>취소</option>
     </select>
   </div>
   <div class="col-auto">
     <button class="btn btn-dark" id="view-btn">조회</button>
     <button class="btn btn-outline-secondary" id="reset-btn">초기화</button>
   </div>
 </div>
<div class="flex-fill">
 <table class="table table-bordered align-middle text-center" id="item_order_list">
   <thead>
     <tr>
       <th style="width: 100px">요청번호</th>
       <th>직영점</th>
       <th>요청일자</th>
       <th style="width: 60px">요일</th>
       <th style="width: 120px">요청시각</th>
       <th style="width: 80px">품목수</th>
       <th>발주액</th>
       <th>발주상태</th>
       <th>입고상태</th>
       <th>처리</th>
     </tr>
   </thead>
   <tbody>
   </tbody>
 </table>
</div>
  <!-- ▼ 페이지네이션 추가 -->
  <nav>
    <ul class="pagination justify-content-center" id="pagination">
      <li class="page-item disabled">
        <a class="page-link" data-page="prev">이전</a>
      </li>
      <li class="page-item active">
        <a class="page-link" data-page="1">1</a>
      </li>
      <li class="page-item">
        <a class="page-link" data-page="next">다음</a>
      </li>
    </ul>
  </nav>
  <!-- ▲ 페이지네이션 끝 -->
</div>
</div>

<!-- 발주 상세 보기 모달 -->
<div class="modal fade details-modal" id="orderItemDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header" style="background:#f8f8f8;">
        <h5 class="modal-title fw-bold">발주 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <h5 class="fw-bold mb-3" id="order-no">[R-2025-1191]</h5>

        <div class="mb-2">
          <span class="me-4" id="store-name_modal">직영점 : 가산점</span>
          <span class="badge bg-warning text-dark" id="order-status-modal">승인</span>
        </div>

        <div class="mb-4" id="order-date-modal">요청일자 : 2025-11-09(일) 23 : 22</div>

        <table class="table table-bordered align-middle text-center" id="item_order_detail_table">
          <thead style="background:#f1f1f1;font-weight:600;">
          <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>카테고리</th>
            <th>발주 수량(기준 단위)</th>
            <th>공급가격</th>
            <th>발주액</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="d-flex justify-content-between mt-3">
          <div>품목수 : <strong id="total_cnt">2 개</strong></div>
          <div>총 발주액 : <strong>164,000 원</strong></div>
        </div>
      </div>

      <div class="modal-footer" id="action-btn">
      </div>

    </div>
  </div>
</div>

<script>
  const itemOrderTable = $("#item_order_list");

  function loadPage(pageNo) {
    const params = new URLSearchParams({
      orderStatus: $("#order-status").val(),
      startDate: $("#start-date").val(),
      endDate: $("#end-date").val(),
      pageNo: pageNo-1
    });
    fetchUtil(`/itemOrder/itemOrderListFilter?${params.toString()}`, (data)=>{
      loadItemOrderTable(data);
      updatePaginationUI(data.pageNo, data.totalPages);
    });
  }

  // 발주 상세 조회
  function loadItemOrderDetail(data) {
    const thead = $("#orderItemDetailModal thead");
    thead.empty();
    const tbody = $("#orderItemDetailModal tbody");
    tbody.empty();
    const footer = $("#action-btn");
    footer.empty();

    const orderStatus = selectedRow.find("td").eq(7).text(); // 발주 상태
    const receiveStatus = selectedRow.find("td").eq(8).text(); // 입고 상태

    $("#order-no").text("#" + selectedRow.find("td").eq(0).text());
    $("#store-name_modal").text(selectedRow.find("td").eq(1).text());
    $("#order-status-modal").text(orderStatus);
      $("#order-date-modal").text("요청일자:  " + selectedRow.find("td").eq(2).text() + "(" +selectedRow.find("td").eq(3).text() + ") " + selectedRow.find("td").eq(4).text());


    // 입고 대기 상태 시 추가
    let header = `
          <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>카테고리</th>
            <th>발주 수량(기준 단위)</th>
            <th>공급가격</th>
            <th>발주액</th>`;
    if(receiveStatus === "입고대기")
      header += `<th>입고상태</th>`;
    header += `</tr>`;
    thead.append(header);

    // body 설정
    data.forEach(item => {
      let row = `
          <tr data-item_order_detail_no="${item.itemOrderDetailNo}">
            <td>${item.itemCode}</td>
            <td class="fw-bold">${item.itemName}</td>
            <td>${item.itemCategoryName}</td>
            <td>${item.itemOrderQuantity} ${item.supplyUnit}</td>
            <td>${item.itemPrice}</td>
            <td>${item.itemOrderPrice}</td>`;
      if(receiveStatus === "입고대기") {
        if (item.receiveDatetime != null)
          row += `<td><button class="btn btn-outline-secondary btn-sm">입고완료</button></td>`;
        else
          row += `<td><button class="btn btn-outline-warning btn-sm receive_btn">입고</button></td>`;
      }
      row += `</tr>`;
      tbody.append(row);
    });

    // 상태 별 처리 버튼 추가
    if(orderStatus === "대기"){
      footer.append(`<button class="btn btn-danger req_cancel_btn">요청 취소</button>`);
    }
    else if(receiveStatus === "입고대기"){
      footer.append(`<button class="btn btn-outline-secondary receive_all_btn">전체 입고처리</button>`);
    }

  }


  // 발주 목록 조회
  const days = ["일", "월", "화", "수", "목", "금", "토"];
  function loadItemOrderTable(data) {
    const tbody = itemOrderTable.find("tbody");
    tbody.empty();

    data.list.forEach(item => {
      const date = new Date(item.requestDate);
      let row = `
              <tr>
                  <td data-orderno="${item.itemOrderNo}">${item.itemOrderNo}</td>
                  <td>${item.storeName}</td>
                  <td>${"" + date.getFullYear() + "-" + String(date.getMonth() + 1).padStart(2, "0") + "-" + String(date.getDate()).padStart(2, "0")}</td>
                  <td>${days[date.getDay()]}</td>
                  <td>${String(date.getHours()).padStart(2, "0") + " : " + String(date.getMinutes()).padStart(2, "0")}</td>
                  <td>${item.quantity}</td>
                  <td>${item.price.toLocaleString()} 원</td>
                  <td style="color: green;" class="req_status">${item.orderStatus}</td>
          `;
      // 발주 요청 상태
      if(item.orderStatus === "승인") row += `<td class="receive_status">${item.receiveStatus}</td>`;
      else row += `<td></td>`;

      row += `<td><button class="btn btn-outline-secondary btn-sm detail_btn" data-bs-toggle="modal" data-bs-target="#orderItemDetailModal">상세조회</button></td>`;

      tbody.append(row + "</tr>");
    });
  }

  $(window).on("load", function () {
    loadPage(1);
  });

  function getItemOrderDetail(itemOrderNo){
    fetchUtil(`/itemOrder/itemOrderDetail/${itemOrderNo}`, (data)=>{
      loadItemOrderDetail(data);
    });
  }

  let selectedRow = null;
  $(document).on("click", ".detail_btn", function(){
    selectedRow = $(this).closest("tr");
    getItemOrderDetail(selectedRow.find("td").data("orderno"));
  });

  function cancelItemOrder(itemOrderNo){
    fetchUtil(`/itemOrder/cancelItemOrder/${itemOrderNo}`, (data)=>{
      if(data.message === "Cancel ItemOrder Success"){
        selectedRow.find(".req_status").text("취소");
        document.activeElement.blur();   // 포커스 제거
        $("#orderItemDetailModal").modal("hide");
      }
    }, "PUT");
  }

  // 클릭 시 주문 상태 상태 변경
  $(document).on("click", ".req_cancel_btn", function(){
    cancelItemOrder(selectedRow.find("td").data("orderno"));
  });

  $(document).on("click", ".receive_btn", function(){
    receiveItem($(this), $(this).closest("tr").data("item_order_detail_no"));
  });

  function receiveItem(btn, itemOrderDetailNo){
    fetchUtil(`/itemOrder/receiveItemOrder/${itemOrderDetailNo}`,(data)=>{
      if(data.message === "Receive ItemOrderDetail Success"){
        btn.closest("td").html(`<button class="btn btn-outline-secondary btn-sm">입고완료</button>`);
        loadPage(currentPage);
      }
    }, "PUT");
  }

  $(document).on("click", "#view-btn", function(){
    loadPage(1);
  });

  function receiveItemOrderDetailAsync(itemOrderDetailNo) {
    return fetch(`/itemOrder/receiveItemOrder/${itemOrderDetailNo}`, {
      method: "PUT",
    })
        .then(res => res.json())
        .then(data => {
          if (data.message === "Receive ItemOrderDetail Success") {
            return true;
          } else {
            throw new Error("Receive failed for orderNo: " + itemOrderDetailNo);
          }
        });
  }

  // 클릭 시 주문 입고 상태 변경
  $(document).on("click", ".receive_all_btn", function(){
    selectedRow.find(".receive_status").text("입고완료");
    document.activeElement.blur();   // 포커스 제거
    $("#orderDetailModal").modal("hide");
  });

  $(document).on("click", ".receive_all_btn", function(){
    const orderDetailNos = [];

    $("#item_order_detail_table").find("tr").each(function(){
      const row = $(this);
      const status = $(this).find("button").eq(0).text();

      if(status === "입고") orderDetailNos.push(row.data("item_order_detail_no"));
    });

    if(orderDetailNos.length === 0) {
      alert("입고 처리할 항목이 없습니다.");
      return;
    }

    const promises = orderDetailNos.map(no => receiveItemOrderDetailAsync(no));
    Promise.all(promises)
        .then(() => {
          loadPage(currentPage);
          $("#orderItemDetailModal").modal("hide");
        })
        .catch(err => {
          console.error(err);
          alert("일부 승인 중 오류가 발생했습니다.");
        });
  });
</script>
</body>
</html>
