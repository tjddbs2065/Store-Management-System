<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>발주 내역</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<script type="application/javascript" src="/js/util.js"></script>
<style>
 body { background:#f8f9fa; font-family:"Noto Sans KR",sans-serif;
   max-width: 1500px;}
 .card-box { background:#fff; border-radius:12px; padding:20px; border:1px solid #dee2e6;}
 .table thead { background:#e9ecef; font-weight:600;}
</style>
</head>
<body class="p-4">

<h3 class="fw-bold mb-4">발주 내역</h3>

<div class="card-box mb-4">

 <div class="row g-3 mb-3">
   <div class="col-auto">
     <input type="date" class="form-control" id="start-date">
   </div>
   <div class="col-auto">
     <input type="date" class="form-control" id="end-date">
   </div>
   <div class="col-auto">
     <select class="form-select" id="order-status">
       <option>전체</option><option>대기</option><option>승인</option><option>취소</option>
     </select>
   </div>
   <div class="col-auto">
     <input type="text" class="form-control" placeholder="직영점 검색" data-bs-toggle="modal" data-bs-target="#storeSearchModal">
   </div>
   <div class="col-auto">
     <button class="btn btn-dark" id="view-btn">조회</button>
   </div>
   <div>
     <button class="btn btn-outline-secondary">일괄 승인</button>
   </div>
 </div>

 <table class="table table-bordered align-middle text-center" id="item_order_list">
   <thead>
     <tr>
       <th><input class="form-check-input" type="checkbox" id="check-all"></th>
       <th>요청번호</th><th>직영점</th><th>요청일자</th><th>요일</th>
       <th>요청시각</th><th>품목수</th><th>발주액</th><th>발주상태</th><th>입고상태</th><th>처리</th>
     </tr>
   </thead>
   <tbody>
   </tbody>
 </table>
  <!-- ▼ 페이지네이션 추가 -->
  <nav>
    <ul class="pagination justify-content-center" id="pagination">
      <li class="page-item disabled">
        <a class="page-link" data-page="prev">이전</a>
      </li>
      <li class="page-item active">
        <a class="page-link" data-page="1">1</a>
      </li>
      <li class="page-item">
        <a class="page-link" data-page="next">다음</a>
      </li>
    </ul>
  </nav>
  <!-- ▲ 페이지네이션 끝 -->
</div>


<!-- 직영점 검색 모달 -->
<div class="modal fade" id="storeSearchModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header" style="background:#495057;color:white;">
        <h5 class="modal-title fw-bold">직영점 검색</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="text" class="form-control mb-3" placeholder="직영점명 입력">

        <table class="table table-bordered align-middle text-center">
          <thead style="background:#e9ecef;">
            <tr><th>직영점명</th><th>주소</th><th>선택</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>금천구청점</td><td>서울 금천구 가산동</td>
              <td><button class="btn btn-dark btn-sm" data-bs-dismiss="modal">선택</button></td>
            </tr>
            <tr>
              <td>강남역점</td><td>서울 강남구 역삼동</td>
              <td><button class="btn btn-dark btn-sm" data-bs-dismiss="modal">선택</button></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>

    </div>
  </div>
</div>

<!-- 발주 상세 보기 모달 -->
<div class="modal fade details-modal" id="orderItemDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header" style="background:#f8f8f8;">
        <h5 class="modal-title fw-bold">발주 상세</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <h5 class="fw-bold mb-3" id="order-no">[R-2025-1191]</h5>

        <div class="mb-2">
          <span class="me-4" id="store-name_modal">직영점 : 가산점</span>
          <span class="badge bg-warning text-dark" id="order-status-modal">승인</span>
        </div>

        <div class="mb-4" id="order-date-modal">요청일자 : 2025-11-09(일) 23 : 22</div>

        <table class="table table-bordered align-middle text-center">
          <thead style="background:#f1f1f1;font-weight:600;">
          <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>카테고리</th>
            <th>발주 수량(기준 단위)</th>
            <th>공급가격</th>
            <th>발주액</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="d-flex justify-content-between mt-3">
          <div>품목수 : <strong id="total_cnt">2 개</strong></div>
          <div>총 발주액 : <strong>164,000 원</strong></div>
        </div>
      </div>

      <div class="modal-footer" id="action-btn">
      </div>

    </div>
  </div>
</div>
<script>
  const itemOrderTable = $("#item_order_list");

  function loadPage(pageNo) {
    const params = new URLSearchParams({
      storeNo: 0,
      orderStatus: $("#order-status").val(),
      startDate: $("#start-date").val(),
      endDate: $("#end-date").val(),
      pageNo: pageNo-1
    });
    fetchUtil(`/itemOrder/itemOrderListFilter?${params.toString()}`, (data)=>{
      loadItemOrderTable(data);
      updatePaginationUI(data.pageNo, data.totalPages);
    });
  }

  // 발주 목록 조회
  const days = ["일", "월", "화", "수", "목", "금", "토"];
  function loadItemOrderTable(data) {
    const tbody = itemOrderTable.find("tbody");
    tbody.empty();

    data.list.forEach(item => {
      const date = new Date(item.requestDate);
      let row = `
              <tr>
                  <td><input class="form-check-input row-check" type="checkbox"></td>
                  <td data-orderno="${item.itemOrderNo}">${item.itemOrderNo}</td>
                  <td>${item.storeName}</td>
                  <td>${"" + date.getFullYear() + "-" + String(date.getMonth() + 1).padStart(2, "0") + "-" + String(date.getDate()).padStart(2, "0")}</td>
                  <td>${days[date.getDay()]}</td>
                  <td>${String(date.getHours()).padStart(2, "0") + " : " + String(date.getMinutes()).padStart(2, "0")}</td>
                  <td>${item.quantity}</td>
                  <td>${item.price.toLocaleString()} 원</td>
                  <td style="color: green;" class="req_status order_status">${item.orderStatus}</td>
          `;
      // 발주 요청 상태
      if(item.orderStatus === "승인") row += `<td class="receive_status">${item.receiveStatus}</td>`;
      else row += `<td></td>`;

      row += `<td><button class="btn btn-outline-secondary btn-sm detail_btn" data-bs-toggle="modal" data-bs-target="#orderItemDetailModal">상세조회</button></td>`;

      tbody.append(row + "</tr>");
    });
  }

  // 발주 상세 조회
  function loadItemOrderDetail(data) {
    const thead = $("#orderItemDetailModal thead");
    thead.empty();
    const tbody = $("#orderItemDetailModal tbody");
    tbody.empty();
    const footer = $("#action-btn");
    footer.empty();

    const orderStatus = selectedRow.find("td").eq(8).text(); // 발주 상태
    const receiveStatus = selectedRow.find("td").eq(9).text(); // 입고 상태

    $("#order-no").text("#" + selectedRow.find("td").eq(1).text()).data("orderno", selectedRow.find("td").eq(1).text());
    $("#store-name_modal").text(selectedRow.find("td").eq(2).text());
    $("#order-status-modal").text(orderStatus);
    $("#order-date-modal").text("요청일자:  " + selectedRow.find("td").eq(3).text() + "(" +selectedRow.find("td").eq(4).text() + ") " + selectedRow.find("td").eq(5).text());


    // 입고 대기 상태 시 추가
    let header = `
          <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>카테고리</th>
            <th>발주 수량(기준 단위)</th>
            <th>공급가격</th>
            <th>발주액</th>`;
    header += `</tr>`;
    thead.append(header);

    // body 설정
    data.forEach(item => {
      let row = `
          <tr data-item_order_detail_no="${item.itemOrderDetailNo}">
            <td>${item.itemCode}</td>
            <td class="fw-bold">${item.itemName}</td>
            <td>${item.itemCategoryName}</td>
            <td>${item.itemOrderQuantity} ${item.supplyUnit}</td>
            <td>${item.itemPrice}</td>
            <td>${item.itemOrderPrice}</td>`;
      row += `</tr>`;
      tbody.append(row);
    });

    // 상태 별 처리 버튼 추가
    if(orderStatus === "대기"){
      footer.append(`<button class="btn btn-success req_cancel_btn approve-btn">승인</button>`);
      footer.append(`<button class="btn btn-danger req_cancel_btn decline-btn">반려</button>`);
    }
  }

  $(window).on("load", function () {
    loadPage(1);
  });

  function getItemOrderDetail(itemOrderNo){
    fetchUtil(`/itemOrder/itemOrderDetail/${itemOrderNo}`, (data)=>{
      loadItemOrderDetail(data);
    });
  }

  let selectedRow = null;
  // 상세조회 버튼
  $(document).on("click", ".detail_btn", function(){
    selectedRow = $(this).closest("tr");
    getItemOrderDetail(selectedRow.find("td").eq(1).data("orderno"));
  });

  function approveItemOrder(orderNo){
    fetchUtil(`/itemOrder/approveItemOrder/${orderNo}`, (data)=>{
      if(data.message === "Approve ItemOrder Success"){
        loadPage(currentPage);
        $("#orderItemDetailModal").modal("hide");
      }
    }, "PUT");
  }
  // 발주 승인 버튼
  $(document).on("click", ".approve-btn", function(){
    // 이곳에 구현부
    const orderNo = $("#order-no").data("orderno");
    approveItemOrder(orderNo);
  });

  // 발주 반려 버튼
  $(document).on("click", ".decline-btn", function(){
    // 이곳에 구현부
    const orderNo = $("#order-no").data("orderno");
    fetchUtil(`/itemOrder/declineItemOrder/${orderNo}`, (data)=>{
      if(data.message === "Decline ItemOrder Success"){
        loadPage(currentPage);
        $("#orderItemDetailModal").modal("hide");
      }
    }, "PUT");
  });

  // 전체 체크박스 시작
  $("#check-all").on("change", function(){
    $(".row-check").prop("checked", $(this).prop("checked"));
  });

  $(document).on("change", ".row-check", function () {
    const total = $(".row-check").length;
    const checked = $(".row-check:checked").length;

    $("#check-all").prop("checked", total === checked);
  });
  // 전체 체크박스 끝

  $(document).on("click", "#view-btn", function(){
    loadPage(1);
  });
</script>
</body>
</html>
