<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>직영점 판매 메뉴</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        th.statusChange { width:90px; }
        .custom-btn {
            background-color:#FFEEAA !important;
            border-color:#FFEEAA !important;
            color:#000;
        }
        .scroll-area { height:500px; overflow-y:auto; }
        .table-fixed-header thead th {
            position:sticky; top:0; background:#f8f9fa; z-index:10;
        }
    </style>
</head>

<body class="bg-light">

<div class="container py-4">
    <div class="bg-white border rounded p-4">

        <h2 class="fw-bold mb-4">직영점 판매 메뉴</h2>

        <div class="border rounded p-3 mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">판매 상태</label>
                    <select class="form-select" id="searchStatus">
                        <option value="">전체</option>
                        <option>판매중</option>
                        <option>판매중단</option>
                        <option>품절</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">카테고리</label>
                    <select class="form-select" id="searchCategory">
                        <option value="">전체</option>
                        <option>피자</option>
                        <option>사이드디시</option>
                        <option>음료</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">메뉴 검색</label>
                    <input type="text" class="form-control" id="searchName">
                </div>

                <div class="col-md-1">
                    <button class="btn custom-btn w-100" id="searchBtn">검색</button>
                </div>
            </div>
        </div>


        <div class="text-end pb-1">
            <button class="btn custom-btn" id="statusSetAllBtn">선택 일괄 변경</button>
        </div>

        <div class="scroll-area">
            <table class="table align-middle text-center table-fixed-header">
                <thead class="table-light">
                <tr>
                    <th>메뉴 코드</th>
                    <th>메뉴 명</th>
                    <th>사이즈</th>
                    <th>가격</th>
                    <th>판매 상태</th>
                    <th class="statusChange">상태 변경</th>
                    <th><input type="checkbox" id="checkAll"></th>
                </tr>
                </thead>

                <tbody id="menuTableBody">

                </tbody>

            </table>
        </div>

    </div>
</div>



<div class="modal fade" id="statusSetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">판매 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row mb-2">
                    <label class="col-3 fw-semibold">메뉴 명</label>
                    <div class="col"><span id="modalMenuName" class="badge bg-light text-dark border px-3 py-2"></span></div>
                </div>

                <div class="row">
                    <label class="col-3 fw-semibold">상태</label>
                    <div class="col">
                        <select class="form-select" id="modalStatusSelect">
                            <option>판매중</option>
                            <option>판매중단</option>
                            <option>품절</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn custom-btn">저장</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>



<script>

    function loadMenuTable(){

        const menuName = $("#searchName").val();
        const salesStatus = $("#searchStatus").val();
        const menuCategory = $("#searchCategory").val();

        $.get(`/storeMenu/getMenu?menuName=${menuName}&salesStatus=${salesStatus}&menuCategory=${menuCategory}`, function(data){

            const tbody = $("#menuTableBody");
            tbody.empty();

            data.forEach(group => {

                const items = group.items;

                // 사이즈 순서 정렬 (라지 → 미디움 → 단일)
                const sorted = [...items].sort((a,b)=>{
                    const order = { "라지":1, "미디움":2, "단일":3 };
                    return order[a.size] - order[b.size];
                });

                const rowSpan = sorted.length;

                sorted.forEach((item, i)=>{

                    let html = "<tr>";

                    if(i === 0){
                        html += `
                        <td rowspan="${rowSpan}">${group.menuCode}</td>
                        <td rowspan="${rowSpan}">${group.menuName}</td>
                    `;
                    }

                    html += `
                    <td>${item.size}</td>
                    <td>${item.menuPrice.toLocaleString()}</td>
                    <td>${item.salesStatus}</td>
                `;

                    if(i === 0){
                        html += `
                        <td rowspan="${rowSpan}">
                            <button class="btn btn-outline-secondary btn-sm statusSetBtn" data-menu="${group.menuName}">
                                변경
                            </button>
                        </td>
                        <td rowspan="${rowSpan}">
                            <input type="checkbox" class="row-check">
                        </td>
                    `;
                    }

                    html += "</tr>";
                    tbody.append(html);
                });

            });

        });
    }

    $("#searchBtn").on("click", loadMenuTable);
    $(document).ready(loadMenuTable);



    $("#checkAll").on("change", function(){
        $(".row-check").prop("checked", this.checked);
    });



    $("#statusSetAllBtn").on("click", function(){

        const checked = $(".row-check:checked");

        if(checked.length === 0){
            alert("선택된 항목이 없습니다.");
            return;
        }

        $("#modalMenuName").text(`선택된 ${checked.length}개 메뉴`);
        $("#statusSetModal").modal("show");
    });


    $(document).on("click", ".statusSetBtn", function(){
        const menu = $(this).data("menu");
        $("#modalMenuName").text(menu);
        $("#statusSetModal").modal("show");
    });
</script>

</body>
</html>
