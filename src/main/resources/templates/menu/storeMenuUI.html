<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>직영점 판매 메뉴</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }
        body { background-color: #fdfdfd; padding-top: 65px !important; }
        .container { max-width:1500px; }
        th.statusChange { width: 90px; }
        .custom-btn {
            background-color:#FFEEAA !important;
            border-color:#FFEEAA !important;
            color:#000;
        }
        .scroll-area { height:500px; overflow-y:auto; }
        .table-fixed-header thead th {
            position:sticky; top:0; background:#f8f9fa; z-index:10;
        }
    </style>
</head>

<body class="bg-light">

<header th:insert="fragments/toolBar :: toolBar"></header>

<div class="container py-4">
    <div class="bg-white border rounded p-4">

        <h2 class="fw-bold mb-4">[[${storeName}]] 판매 메뉴 </h2>

        <div class="border rounded p-3 mb-4">
            <div class="row g-3 align-items-end">

                <div class="col-md-2">
                    <label class="form-label">판매 상태</label>
                    <select class="form-select" id="searchStatus">
                        <option value="">전체</option>
                        <option>판매중</option>
                        <option>판매중단</option>
                        <option>품절</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">카테고리</label>
                    <select class="form-select" id="searchCategory">
                        <option value="">전체</option>
                        <option>피자</option>
                        <option>사이드디시</option>
                        <option>음료</option>
                        <option>기타</option>
                    </select>
                </div>

            </div>
        </div>

        <div class="text-end pb-1">
            <button class="btn custom-btn" id="statusSetAllBtn">선택 일괄 변경</button>
        </div>

        <div class="scroll-area">
            <table class="table align-middle text-center table-fixed-header">
                <thead class="table-light">
                <tr>
                    <th>메뉴 코드</th>
                    <th>카테고리</th>
                    <th>메뉴 명</th>
                    <th>사이즈</th>
                    <th>가격</th>
                    <th>판매 상태</th>
                    <th class="statusChange">상태 변경</th>
                    <th><input type="checkbox" id="checkAll"></th>
                </tr>
                </thead>
                <tbody id="menuTableBody"></tbody>
            </table>
        </div>

    </div>
</div>


<!-- 단건/일괄 변경 모달 -->
<div class="modal fade" id="statusSetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">판매 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-3">
                    <label class="col-3 fw-semibold">메뉴 명</label>
                    <div class="col">
                        <span id="modalMenuName" class="badge bg-light text-dark border px-3 py-2"></span>
                    </div>
                </div>

                <div class="row mb-2">
                    <label class="col-3 fw-semibold">사이즈</label>
                    <label class="col-3 fw-semibold">판매 상태</label>
                </div>

                <div id="modalSizeArea"></div>

            </div>

            <div class="modal-footer">
                <button class="btn custom-btn" id="saveStatusBtn">저장</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>

        </div>
    </div>
</div>

<!-- 알림 모달 -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center border border-primary">
            <div class="modal-body">
                <p id="alertMessage" class="fs-5 fw-bold mb-4 text-dark"></p>
                <div class="d-flex justify-content-center gap-3">
                    <button type="button" class="btn px-4 custom-btn" data-bs-dismiss="modal">확인</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로그인한 점주의 매장 menu_stop_role → hidden 으로 내려보내기 -->
<input type="hidden"
       id="menuStopRoleValue"
       th:value="${#authentication?.principal?.store?.menuStopRole ?: 'N'}"/>

<script src="/js/util.js"></script>

<script>
    // menu_stop_role 값을 JS 전역으로 노출
    (function () {
        const el   = document.getElementById('menuStopRoleValue');
        const role = el ? (el.value || 'N') : 'N';   // DB 는 NOT NULL 이지만, 방어적으로 'N' 기본값

        window.MENU_STOP_ROLE    = role;          // 'Y' / 'N'
        window.CAN_USE_MENU_STOP = (role === 'Y'); // Y 일 때만 "판매중단" 옵션 노출
    })();

    function showAlert(msg){
        $("#alertMessage").text(msg);
        $("#alertModal").modal("show");
    }

    /**
     * 점주 화면에서 사용할 판매 상태 옵션 생성
     */
    function buildStoreStatusOptions(currentStatus) {
        let html = '';

        // 판매중
        html += '<option ' + (currentStatus === '판매중' ? 'selected' : '') + '>판매중</option>';

        // 판매중단 (점주 권한이 있을 때만 노출)
        if (window.CAN_USE_MENU_STOP) {
            html += '<option ' + (currentStatus === '판매중단' ? 'selected' : '') + '>판매중단</option>';
        }

        // 품절
        html += '<option ' + (currentStatus === '품절' ? 'selected' : '') + '>품절</option>';

        return html;
    }

    function collectUpdates(){
        const updates = [];
        const bulkSelect = $("#bulkStatusSelect");

        // 일괄 변경인 경우
        if(bulkSelect && bulkSelect.length > 0){
            const status = bulkSelect.val();

            window.bulkItems.forEach(function(item){
                updates.push({
                    storeMenuNo: item.storeMenuNo,
                    salesStatus: status
                });
            });

            return updates;
        }

        // 단건 변경인 경우
        $("#modalSizeArea select").each(function(){
            updates.push({
                storeMenuNo: $(this).data("storemenu"),
                salesStatus: $(this).val()
            });
        });

        return updates;
    }

    $(document).on("click", "#saveStatusBtn", function(){

        const updates = collectUpdates();

        fetchUtil(
            "/storeMenu/updateStatus",
            function(){
                $("#statusSetModal").modal("hide");
                loadMenuTable();
                $("#checkAll, .row-check").prop("checked", false);
            },
            "POST",
            updates
        );
    });

    // ==========================
    // 테이블 렌더링
    // ==========================
    function renderMenuTable(data){

        const tbody = $("#menuTableBody");
        tbody.empty();

        if(!data || data.length === 0){
            tbody.append('<tr><td colspan="8" class="text-center">데이터가 없습니다.</td></tr>');
            return;
        }

        data.forEach(function(group){

            const items = group.items;
            const sorted = items.slice().sort(function(a, b){
                const order = { "라지":1, "미디움":2, "단일":3 };
                return order[a.size] - order[b.size];
            });

            const rowSpan = sorted.length;

            sorted.forEach(function(item, i){

                let html = "<tr>";

                if(i === 0){
                    html += ''
                        + '<td rowspan="' + rowSpan + '">' + group.menuCode + '</td>'
                        + '<td rowspan="' + rowSpan + '">' + item.menuCategory + '</td>'
                        + '<td rowspan="' + rowSpan + '">' + group.menuName + '</td>';
                }

                html += ''
                    + '<td>' + item.size + '</td>'
                    + '<td>' + item.menuPrice.toLocaleString() + '</td>'
                    + '<td>' + item.salesStatus + '</td>';

                if(i === 0){
                    html += ''
                        + '<td rowspan="' + rowSpan + '">'
                        + '  <button class="btn btn-outline-secondary btn-sm statusSetBtn"'
                        + '      data-menu="' + group.menuName + '"'
                        + '      data-items="' + btoa(encodeURIComponent(JSON.stringify(sorted))) + '">'
                        + '      변경'
                        + '  </button>'
                        + '</td>'
                        + '<td rowspan="' + rowSpan + '">'
                        + '  <input type="checkbox" class="row-check">'
                        + '</td>';
                }

                html += "</tr>";
                tbody.append(html);
            });
        });
    }

    // ==========================
    // 데이터 로딩
    // ==========================
    function loadMenuTable() {

        const salesStatus  = $("#searchStatus").val();
        const menuCategory = $("#searchCategory").val();

        const url = "/storeMenu/getMenu?salesStatus=" + salesStatus + "&menuCategory=" + menuCategory;

        fetchUtil(url, function(data){
            renderMenuTable(data);
        });
    }

    // ==========================
    // 이벤트 바인딩
    // ==========================
    $(document).ready(function(){
        loadMenuTable();
    });

    $("#searchStatus").on("change", function(){
        loadMenuTable();
    });

    $("#searchCategory").on("change", function(){
        loadMenuTable();
    });

    $("#checkAll").on("change", function(){
        $(".row-check").prop("checked", this.checked);
    });

    // 단건 변경 버튼 클릭
    $(document).on("click", ".statusSetBtn", function(){

        const menuName = $(this).data("menu");
        const items = JSON.parse(decodeURIComponent(atob($(this).data("items"))));

        $("#modalMenuName").text(menuName);
        const area = $("#modalSizeArea").empty();

        items.forEach(function(item){
            const optionsHtml = buildStoreStatusOptions(item.salesStatus);

            area.append(''
                + '<div class="row mb-2">'
                + '  <label class="col-3 fw-semibold">' + item.size + '</label>'
                + '  <div class="col">'
                + '      <select class="form-select" data-storemenu="' + item.storeMenuNo + '">'
                +            optionsHtml
                + '      </select>'
                + '  </div>'
                + '</div>'
            );
        });

        $("#statusSetModal").modal("show");
    });

    // 선택 일괄 변경
    $(document).on("click", "#statusSetAllBtn", function(){

        const checkedRows = $(".row-check:checked");
        if(checkedRows.length === 0){
            showAlert("선택된 항목이 없습니다.");
            return;
        }

        window.bulkItems = [];

        let totalItems = 0;
        let firstName = null;

        checkedRows.each(function(){
            const row = $(this).closest("tr");
            const encoded = row.find(".statusSetBtn").data("items");
            const items = JSON.parse(decodeURIComponent(atob(encoded)));

            window.bulkItems.push.apply(window.bulkItems, items);

            totalItems += items.length;
            if(!firstName) firstName = items[0].menuName;
        });

        // 일괄 변경용 select → 여기서도 메뉴중단 옵션은 CAN_USE_MENU_STOP 에 따라 제거
        const optionsHtml = buildStoreStatusOptions('판매중');

        $("#modalMenuName").text(firstName + " 외 " + (totalItems - 1) + "건");

        $("#modalSizeArea").html(''
            + '<div class="row mb-2">'
            + '  <label class="col-3 fw-semibold">전체</label>'
            + '  <div class="col">'
            + '      <select class="form-select" id="bulkStatusSelect">'
            +            optionsHtml
            + '      </select>'
            + '  </div>'
            + '</div>'
        );

        $("#statusSetModal").modal("show");
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
