<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>직영점 판매 메뉴</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        th.statusChange { width:90px; }
        .custom-btn {
            background-color:#FFEEAA !important;
            border-color:#FFEEAA !important;
            color:#000;
        }
        .scroll-area { height:500px; overflow-y:auto; }
        .table-fixed-header thead th {
            position:sticky; top:0; background:#f8f9fa; z-index:10;
        }
    </style>
</head>

<body class="bg-light">

<div class="container py-4">
    <div class="bg-white border rounded p-4">

        <h2 class="fw-bold mb-4">직영점 판매 메뉴</h2>

        <!-- 검색 -->
        <div class="border rounded p-3 mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">판매 상태</label>
                    <select class="form-select" id="searchStatus">
                        <option value="">전체</option>
                        <option>판매중</option>
                        <option>판매중단</option>
                        <option>품절</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">카테고리</label>
                    <select class="form-select" id="searchCategory">
                        <option value="">전체</option>
                        <option>피자</option>
                        <option>사이드디시</option>
                        <option>음료</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">메뉴 검색</label>
                    <input type="text" class="form-control" id="searchName">
                </div>

                <div class="col-md-1">
                    <button class="btn custom-btn w-100" id="searchBtn">검색</button>
                </div>
            </div>
        </div>

        <div class="text-end pb-1">
            <button class="btn custom-btn" id="statusSetAllBtn">선택 일괄 변경</button>
        </div>

        <!-- 테이블 -->
        <div class="scroll-area">
            <table class="table align-middle text-center table-fixed-header">
                <thead class="table-light">
                <tr>
                    <th>메뉴 코드</th>
                    <th>카테고리</th> <!-- 추가 -->
                    <th>메뉴 명</th>
                    <th>사이즈</th>
                    <th>가격</th>
                    <th>판매 상태</th>
                    <th class="statusChange">상태 변경</th>
                    <th><input type="checkbox" id="checkAll"></th>
                </tr>
                </thead>

                <tbody id="menuTableBody"></tbody>
            </table>
        </div>

    </div>
</div>


<!-- 판매 변경 모달 -->
<div class="modal fade" id="statusSetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">판매 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-3">
                    <label class="col-3 fw-semibold">메뉴 명</label>
                    <div class="col">
                        <span id="modalMenuName"
                              class="badge bg-light text-dark border px-3 py-2"></span>
                    </div>
                </div>

                <div class="row mb-2 border-bottom pb-1">
                    <label class="col-3 fw-semibold">사이즈</label>
                    <label class="col fw-semibold">판매 상태</label>
                </div>

                <!-- 동적 생성 영역 -->
                <div id="modalSizeArea"></div>

            </div>

            <div class="modal-footer">
                <button class="btn custom-btn">저장</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>

        </div>
    </div>
</div>



<script>

    /* =============================
       목록 로딩
    ============================= */
    function loadMenuTable(){

        const menuName = $("#searchName").val();
        const salesStatus = $("#searchStatus").val();
        const menuCategory = $("#searchCategory").val();

        $.get(`/storeMenu/getMenu?menuName=${menuName}&salesStatus=${salesStatus}&menuCategory=${menuCategory}`,
            function(data){

                const tbody = $("#menuTableBody");
                tbody.empty();

                data.forEach(group => {

                    const items = [...group.items].sort((a,b)=> {
                        const order = { "라지":1, "미디움":2, "단일":3 };
                        return order[a.size] - order[b.size];
                    });

                    const rowSpan = items.length;

                    items.forEach((item, i) => {

                        let html = "<tr>";

                        if(i === 0){
                            html += `
                        <td rowspan="${rowSpan}">${group.menuCode}</td>
                        <td rowspan="${rowSpan}">${item.menuCategory}</td>
                        <td rowspan="${rowSpan}">${group.menuName}</td>
                    `;
                        }

                        html += `
                    <td>${item.size}</td>
                    <td>${item.menuPrice.toLocaleString()}</td>
                    <td>${item.salesStatus}</td>
                `;

                        if(i === 0){
                            html += `
                        <td rowspan="${rowSpan}">
                            <button class="btn btn-outline-secondary btn-sm statusSetBtn"
                                    data-menu="${group.menuName}"
                                    data-code="${group.menuCode}">
                                변경
                            </button>
                        </td>
                        <td rowspan="${rowSpan}">
                            <input type="checkbox" class="row-check">
                        </td>
                    `;
                        }

                        html += "</tr>";
                        tbody.append(html);
                    });

                });

            });
    }

    $(document).ready(loadMenuTable);
    $("#searchBtn").on("click", loadMenuTable);

    /* 전체 선택 */
    $("#checkAll").on("change", function(){
        $(".row-check").prop("checked", this.checked);
    });


    /* =============================
       개별 변경 모달
    ============================= */
    $(document).on("click", ".statusSetBtn", function(){

        const menuName = $(this).data("menu");
        const menuCode = $(this).data("code");

        $("#modalMenuName").text(menuName);
        $("#modalSizeArea").empty();

        const groupRows = $("#menuTableBody tr").filter(function(){
            const firstCell = $(this).find("td").first();
            if (firstCell.attr("rowspan")) {
                return firstCell.text().trim() === menuCode;
            }
            const parentCode = $(this).prevAll()
                .filter((i, el) => $(el).find("td:first").attr("rowspan"))
                .first()
                .find("td:first").text().trim();
            return parentCode === menuCode;
        });

        /* 카테고리 추가되었으므로 nth-child 수정됨 */
        groupRows.each(function(){

            const size   = $(this).children("td:nth-child(4)").text().trim();
            const status = $(this).children("td:nth-child(6)").text().trim();

            $("#modalSizeArea").append(`
            <div class="row mb-2">
                <label class="col-3 fw-semibold">${size}</label>
                <div class="col">
                    <select class="form-select">
                        <option ${status==="판매중"?"selected":""}>판매중</option>
                        <option ${status==="판매중단"?"selected":""}>판매중단</option>
                        <option ${status==="품절"?"selected":""}>품절</option>
                    </select>
                </div>
            </div>
        `);
        });

        $("#statusSetModal").modal("show");
    });

</script>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

</body>
</html>
