<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>메뉴 수정</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body {
            background-color: #f5f5f5 !important;
        }

        /* 전체 감싸는 박스 */
        .wrapper-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            border: 1px solid #ddd;
            max-width: 1500px;
            margin: 0 auto;
        }

        .section-inner {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 25px;
            margin-bottom: 30px;
        }

        th, td {
            vertical-align: middle !important;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 5;
        }

        .table-responsive {
            max-height: 350px;
            overflow-y: auto;
        }

        /* 숫자 input 화살표 제거 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .custom-btn {
            background-color: #FFEEAA !important;
            border-color: #FFEEAA !important;
            color: #000;
        }
        .custom-btn:hover {
            background-color: #f2da84 !important;
            border-color: #f2da84 !important;
        }

        .gray-btn {
            background-color: #D9D9D9 !important;
            border: #ffffff !important;
        }
        .gray-btn:hover {
            background-color: #C9C9C9 !important;
            border-color: #ffffff !important;
        }
    </style>
</head>

<body class="py-5">

<div class="wrapper-box">

    <!-- 숨김값 (서버에서 전달된 정보) -->
    <input type="hidden" id="menuNos" th:value="${menuNos}">
    <input type="hidden" id="hasSize" th:value="${hasSize}">
    <input type="hidden" id="baseMenuNo" th:value="${menu.menuNo}">

    <!-- 제목 + 뒤로가기 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">메뉴 수정</h2>
        <button class="btn btn-outline-secondary" onclick="history.back()">뒤로가기</button>
    </div>

    <!-- ===================== -->
    <!-- 기본 정보 section -->
    <!-- ===================== -->
    <div class="section-inner">
        <h5 class="fw-bold mb-4">기본 정보</h5>

        <div class="row g-4">

            <!-- 카테고리 -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">카테고리</label>
                <select class="form-select" id="menuCategory">
                    <option th:selected="${menu.menuCategory == '피자'}">피자</option>
                    <option th:selected="${menu.menuCategory == '사이드디시'}">사이드디시</option>
                    <option th:selected="${menu.menuCategory == '음료'}">음료</option>
                </select>
            </div>

            <!-- 메뉴 코드 -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">메뉴 코드</label>
                <input type="text" class="form-control" id="menuCode" th:value="${menu.menuCode}">
            </div>

            <!-- 메뉴 명 -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">메뉴 명</label>
                <input type="text" class="form-control" id="menuName" th:value="${menu.menuName}">
            </div>

            <!-- 사이즈 여부 (구조 변경 방지용으로 disabled) -->
            <div class="col-md-4">
                <label class="form-label fw-semibold d-block">사이즈</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="sizeYn" value="Y"
                           th:checked="${hasSize}" disabled>
                    <label class="form-check-label">유</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="sizeYn" value="N"
                           th:checked="${!hasSize}" disabled>
                    <label class="form-check-label">무</label>
                </div>
            </div>

            <!-- 사이즈별 가격 (라지/미디움) -->
            <div class="col-md-4" th:if="${hasSize}"
                 th:each="s : ${sizeList}">
                <label class="form-label fw-semibold"
                       th:text="${s.size + ' 가격'}"></label>
                <div class="input-group input-group-sm w-auto">
                    <input type="number"
                           class="form-control price-input"
                           th:value="${s.menuPrice}"
                           th:attr="data-size=${s.size}">
                    <span class="input-group-text">원</span>
                </div>
            </div>

            <!-- 단일 가격 -->
            <div class="col-md-4" th:if="${!hasSize}">
                <label class="form-label fw-semibold">판매 가격</label>
                <div class="input-group input-group-sm w-auto">
                    <input type="number" class="form-control" id="priceSingle"
                           th:value="${menu.menuPrice}">
                    <span class="input-group-text">원</span>
                </div>
            </div>

            <!-- 설명 -->
            <div class="col-12">
                <label class="form-label fw-semibold">설명</label>
                <textarea class="form-control" rows="3" id="menuExplain"
                          th:text="${menu.menuExplain}"></textarea>
            </div>

            <!-- 출시 상태 -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">출시 상태</label>
                <select class="form-select" id="releaseStatus">
                    <option th:selected="${menu.releaseStatus == '출시 예정'}">출시 예정</option>
                    <option th:selected="${menu.releaseStatus == '출시 중'}">출시 중</option>
                    <option th:selected="${menu.releaseStatus == '출시 중지'}">출시 중지</option>
                </select>
            </div>

            <!-- 대표 이미지 (경로 입력 방식) -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">대표 이미지 경로</label>
                <input type="text" class="form-control" id="menuImage"
                       th:value="${menu.menuImage}">
                <div class="mt-2">
                    <img th:src="${menu.menuImage}" alt="대표 이미지" class="img-thumbnail" style="max-width: 200px;">
                </div>
            </div>

        </div>
    </div>

    <!-- ===================== -->
    <!-- 레시피 정보 section -->
    <!-- ===================== -->
    <div class="section-inner">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold">레시피(재료) 정보</h5>
            <button class="btn btn-sm custom-btn" data-bs-toggle="modal" data-bs-target="#ingredientModal">
                + 재료 불러오기
            </button>
        </div>

        <table class="table text-center align-middle">
            <thead class="table-light">
            <tr>
                <th>재료명</th>
                <th>단위</th>
                <th class="size-option">라지 정량</th>
                <th class="size-option">미디움 정량</th>
                <th class="qty-single-header" style="display:none;">정량</th>
                <th>삭제</th>
            </tr>
            </thead>

            <!-- 사이즈 메뉴일 때 레시피 -->
            <tbody id="recipeList" th:if="${hasSize}">
            <tr th:each="ing : ${ingredients}">
                <td th:text="${ing.ingredientName}"></td>
                <td th:text="${ing.stockUnit}"></td>
                <td class="size-option">
                    <input type="number"
                           class="form-control form-control-sm w-auto qty-large"
                           th:value="${ing.quantityLarge}">
                </td>
                <td class="size-option">
                    <input type="number"
                           class="form-control form-control-sm w-auto qty-medium"
                           th:value="${ing.quantityMedium}">
                </td>
                <td class="qty-single-cell" style="display:none;"></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>
                    <input type="hidden" class="item-no" th:value="${ing.itemNo}">
                </td>
            </tr>
            </tbody>

            <!-- 단일 메뉴일 때 레시피 -->
            <tbody id="recipeList" th:if="${!hasSize}">
            <tr th:each="ing : ${ingredients}">
                <td th:text="${ing.ingredientName}"></td>
                <td th:text="${ing.stockUnit}"></td>
                <td class="size-option" style="display:none;"></td>
                <td class="size-option" style="display:none;"></td>
                <td class="qty-single-cell">
                    <input type="number"
                           class="form-control form-control-sm w-auto qty-single"
                           th:value="${ing.quantity}">
                </td>
                <td>
                    <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>
                    <input type="hidden" class="item-no" th:value="${ing.itemNo}">
                </td>
            </tr>
            </tbody>

        </table>

    </div>

    <div class="text-center mt-3">
        <button class="btn custom-btn" id="saveBtn">저장</button>
        <button class="btn gray-btn" id="cancelBtn">취소</button>
    </div>

</div>

<!-- ============================= -->
<!-- 재료 불러오기 모달 -->
<!-- ============================= -->
<div class="modal fade" id="ingredientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="fw-bold modal-title">재료 불러오기</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">카테고리</label>
                        <select class="form-select" id="modalCategory">
                            <option>전체</option>
                            <option>도우</option>
                            <option>치즈</option>
                            <option>토핑</option>
                            <option>소스</option>
                            <option>향신료</option>
                            <option>야채</option>
                            <option>면</option>
                            <option>사이드</option>
                            <option>음료</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">검색조건</label>
                        <select class="form-select" id="modalSearchType">
                            <option>품목코드</option>
                            <option>재료명</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">검색어</label>
                        <input type="text" class="form-control" id="modalKeyword">
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-dark" id="modalSearchBtn">조회</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="checkAll"></th>
                            <th>품목 코드</th>
                            <th>재료 명</th>
                            <th>카테고리</th>
                            <th>기준 단위</th>
                        </tr>
                        </thead>

                        <tbody id="ingredientTableBody">
                        <!-- 임시 예시 데이터 (실사용 시 fetch로 대체) -->
                        <tr data-itemno="1">
                            <td><input type="checkbox" class="row-check"></td>
                            <td>DOUGH-M</td>
                            <td>피자 도우 M</td>
                            <td>도우</td>
                            <td>ea</td>
                        </tr>

                        <tr data-itemno="2">
                            <td><input type="checkbox" class="row-check"></td>
                            <td>CHEESE-MOZZ</td>
                            <td>모짜렐라 치즈</td>
                            <td>치즈</td>
                            <td>g</td>
                        </tr>

                        <tr data-itemno="3">
                            <td><input type="checkbox" class="row-check"></td>
                            <td>SAUCE-TOMATO</td>
                            <td>토마토 소스</td>
                            <td>소스</td>
                            <td>g</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn custom-btn" id="modalAddSelected">선택 재료 등록</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>

        </div>
    </div>
</div>


<script>
    // 사이즈 유무에 따라 표기 전환
    function updateSize() {
        var hasSize = $("#hasSize").val() === "true";

        $(".price-input").closest(".col-md-4").toggle(hasSize);
        $("#priceSingle").closest(".col-md-4").toggle(!hasSize);

        $("th.size-option, td.size-option").toggle(hasSize);
        $("th.qty-single-header, td.qty-single-cell").toggle(!hasSize);
    }

    // 전체 선택
    $("#checkAll").change(function () {
        $(".row-check").prop("checked", $(this).is(":checked"));
    });

    // 모달 - 선택 재료 추가
    $("#modalAddSelected").click(function () {
        var hasSize = $("#hasSize").val() === "true";
        var recipeBody = $("#recipeList");
        var selectedRows = $(".row-check:checked");

        selectedRows.each(function () {
            var row = $(this).closest("tr");
            var itemNo = row.data("itemno");
            var cols = row.children();
            var name = cols.eq(2).text();
            var unit = cols.eq(4).text();

            var html = "";
            if (hasSize) {
                html =
                    '<tr>' +
                    '  <td>' + name + '</td>' +
                    '  <td>' + unit + '</td>' +
                    '  <td class="size-option">' +
                    '    <input type="number" class="form-control form-control-sm w-auto qty-large" placeholder="라지">' +
                    '  </td>' +
                    '  <td class="size-option">' +
                    '    <input type="number" class="form-control form-control-sm w-auto qty-medium" placeholder="미디움">' +
                    '  </td>' +
                    '  <td class="qty-single-cell" style="display:none;"></td>' +
                    '  <td>' +
                    '    <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>' +
                    '    <input type="hidden" class="item-no" value="' + itemNo + '">' +
                    '  </td>' +
                    '</tr>';
            } else {
                html =
                    '<tr>' +
                    '  <td>' + name + '</td>' +
                    '  <td>' + unit + '</td>' +
                    '  <td class="size-option" style="display:none;"></td>' +
                    '  <td class="size-option" style="display:none;"></td>' +
                    '  <td class="qty-single-cell">' +
                    '    <input type="number" class="form-control form-control-sm w-auto qty-single" placeholder="정량">' +
                    '  </td>' +
                    '  <td>' +
                    '    <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>' +
                    '    <input type="hidden" class="item-no" value="' + itemNo + '">' +
                    '  </td>' +
                    '</tr>';
            }

            recipeBody.append(html);
        });

        $("#ingredientModal").modal("hide");
    });

    // 레시피 행 삭제
    $(document).on("click", ".delete-row", function () {
        $(this).closest("tr").remove();
    });

    // 저장 버튼 클릭 → MenuDTO 형태로 JSON 직렬화 후 POST
    $("#saveBtn").click(function () {
        var hasSize = $("#hasSize").val() === "true";

        var menuRequest = {};
        menuRequest.menuNo = parseInt($("#baseMenuNo").val(), 10);
        menuRequest.menuName = $("#menuName").val();
        menuRequest.menuCode = $("#menuCode").val();
        menuRequest.menuCategory = $("#menuCategory").val();
        menuRequest.menuExplain = $("#menuExplain").val();
        menuRequest.menuImage = $("#menuImage").val();
        menuRequest.releaseStatus = $("#releaseStatus").val();
        menuRequest.size = hasSize ? "Y" : "N";

        if (hasSize) {
            $(".price-input").each(function () {
                var size = $(this).data("size");  // 라지 / 미디움
                var price = parseInt($(this).val(), 10) || 0;
                if (size === "라지") {
                    menuRequest.menuPriceLarge = price;
                } else if (size === "미디움") {
                    menuRequest.menuPriceMedium = price;
                }
            });
        } else {
            menuRequest.menuPrice = parseInt($("#priceSingle").val(), 10) || 0;
        }

        // 재료 리스트 구성
        var ingredients = [];
        $("#recipeList tr").each(function () {
            var tds = $(this).children("td");
            if (tds.length === 0) return;

            var dto = {};
            dto.ingredientName = tds.eq(0).text();
            dto.stockUnit = tds.eq(1).text();
            dto.itemNo = parseInt($(this).find(".item-no").val(), 10) || null;

            if (hasSize) {
                var qL = $(this).find(".qty-large").val();
                var qM = $(this).find(".qty-medium").val();
                dto.quantityLarge = qL ? parseInt(qL, 10) : null;
                dto.quantityMedium = qM ? parseInt(qM, 10) : null;
            } else {
                var q = $(this).find(".qty-single").val();
                dto.quantity = q ? parseInt(q, 10) : null;
            }

            ingredients.push(dto);
        });

        menuRequest.ingredients = ingredients;

        fetch("/menu/menuSet", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(menuRequest)
        }).then(function (res) {
            if (!res.ok) {
                throw new Error("save fail");
            }
            return res.text();
        }).then(function () {
            alert("메뉴가 저장되었습니다.");
            location.href = "/menu/menuUI";
        }).catch(function (err) {
            console.error(err);
            alert("저장 중 오류가 발생했습니다.");
        });
    });

    // 취소 버튼
    $("#cancelBtn").click(function () {
        history.back();
    });

    // 초기 로딩 시 사이즈에 맞게 화면 정리
    $(function () {
        updateSize();
    });
</script>

</body>
</html>
