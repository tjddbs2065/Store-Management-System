<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>메뉴 수정</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/util.js"></script>

    <style>
        body {
            background-color: #f5f5f5 !important;
        }

        .wrapper-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            border: 1px solid #ddd;
            max-width: 1500px;
            margin: 0 auto;
        }

        .section-inner {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 25px;
            margin-bottom: 30px;
        }

        th, td {
            vertical-align: middle !important;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 5;
        }

        .table-responsive {
            max-height: 350px;
            overflow-y: auto;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
        }
        input[type=number] { -moz-appearance: textfield; }

        .custom-btn {
            background-color: #FFEEAA !important;
            border-color: #FFEEAA !important;
            color: #000;
        }
        header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
        }
        .custom-btn:hover {
            background-color: #f2da84 !important;
            border-color: #f2da84 !important;
        }

        .gray-btn {
            background-color: #D9D9D9 !important;
            border: #ffffff !important;
        }

        .gray-btn:hover {
            background-color: #C9C9C9 !important;
            border-color: #ffffff !important;
        }

        .recipe-input {
            width: 80px !important;
            height: 32px !important;
            padding: 4px 8px !important;
            margin: 0 auto;
            display: block;
        }
        .form-control-sm{
            max-width: 260px;
        }
        .detail-img {
            width: 220px;
            height: 160px;
            object-fit: cover;
        }
    </style>
</head>

<body class="py-5">
<header th:insert="fragments/toolBar :: toolBar"></header>
<div class="wrapper-box">

    <input type="hidden" id="menuNos" th:value="${menuNos}">
    <input type="hidden" id="hasSize" th:value="${hasSize}">
    <input type="hidden" id="baseMenuNo" th:value="${menu.menuNo}">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">메뉴 수정</h2>
    </div>

    <div class="section-inner">
        <h5 class="fw-bold mb-4">기본 정보</h5>

        <div class="row g-4">

            <div class="col-md-4">
                <label class="form-label fw-semibold">카테고리</label>
                <div class="border rounded px-3 py-2 bg-light" th:text="${menu.menuCategory}"></div>
                <input type="hidden" id="menuCategory" th:value="${menu.menuCategory}">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">메뉴 코드</label>
                <input type="text" class="form-control" id="menuCode" th:value="${menu.menuCode}">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">메뉴 명</label>
                <input type="text" class="form-control" id="menuName" th:value="${menu.menuName}">
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold d-block">사이즈</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="sizeYn" value="Y" th:checked="${hasSize}" disabled>
                    <label class="form-check-label">유</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="sizeYn" value="N" th:checked="${!hasSize}" disabled>
                    <label class="form-check-label">무</label>
                </div>
            </div>

            <div class="col-md-4" th:if="${hasSize}" th:each="s : ${sizeList}">
                <label class="form-label fw-semibold" th:text="${s.size + ' 가격'}"></label>
                <div class="input-group input-group-sm w-auto">
                    <input type="number" class="form-control price-input"
                           th:value="${s.menuPrice}" th:attr="data-size=${s.size}">
                    <span class="input-group-text">원</span>
                </div>
            </div>

            <div class="col-md-4" th:if="${!hasSize}">
                <label class="form-label fw-semibold">판매 가격</label>
                <div class="input-group input-group-sm w-auto">
                    <input type="number" class="form-control" id="priceSingle" th:value="${menu.menuPrice}">
                    <span class="input-group-text">원</span>
                </div>
            </div>

            <div class="col-12">
                <label class="form-label fw-semibold">설명</label>
                <textarea class="form-control" rows="3" id="menuExplain"
                          th:text="${menu.menuExplain}"></textarea>
            </div>
            <div class="d-flex  gap-5">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">출시 상태</label>
                    <select class="form-select" id="releaseStatus">
                        <option th:selected="${menu.releaseStatus == '출시 예정'}">출시 예정</option>
                        <option th:selected="${menu.releaseStatus == '출시 중'}">출시 중</option>
                        <option th:selected="${menu.releaseStatus == '출시 중지'}">출시 중지</option>
                    </select>
                </div>
                <div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <label class="form-label fw-semibold mb-0">대표 이미지</label>

                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                id="removeImageBtn">
                            이미지 삭제
                        </button>
                    </div>
                    <input type="file" class="form-control form-control-sm mb-2" id="menuImage" >
                    <div class="mt-2" id="imageArea">
                        <img th:if="${menu.menuImage != null}"
                             th:src="${menu.menuImage}"
                             th:alt="${menu.menuName}"
                             class="detail-img rounded shadow-sm mb-2">
                    </div>
                    <input type="hidden" id="originImage" th:value="${menu.menuImage}">
                    <input type="hidden" id="removeImage" value="false">
                </div>
            </div>
        </div>
    </div>

    <div class="section-inner">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold">레시피(재료) 정보</h5>
            <button class="btn btn-sm custom-btn" data-bs-toggle="modal" data-bs-target="#ingredientModal">
                + 재료 불러오기
            </button>
        </div>

        <table class="table text-center align-middle">
            <thead class="table-light">
            <tr>
                <th>재료명</th>
                <th>단위</th>
                <th class="size-option">라지 정량</th>
                <th class="size-option">미디움 정량</th>
                <th class="qty-single-header" style="display:none;">정량</th>
                <th>삭제</th>
            </tr>
            </thead>

            <tbody id="recipeList" th:if="${hasSize}">
            <tr th:each="ing : ${ingredients}">
                <td th:text="${ing.ingredientName}"></td>
                <td th:text="${ing.stockUnit}"></td>
                <td class="size-option">
                    <input type="number" class="form-control recipe-input qty-large"
                           th:value="${ing.quantityLarge}">
                </td>
                <td class="size-option">
                    <input type="number" class="form-control recipe-input qty-medium"
                           th:value="${ing.quantityMedium}">
                </td>
                <td class="qty-single-cell" style="display:none;"></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>
                    <input type="hidden" class="item-no" th:value="${ing.itemNo}">
                </td>
            </tr>
            </tbody>

            <tbody id="recipeList" th:if="${!hasSize}">
            <tr th:each="ing : ${ingredients}">
                <td th:text="${ing.ingredientName}"></td>
                <td th:text="${ing.stockUnit}"></td>
                <td class="size-option" style="display:none;"></td>
                <td class="size-option" style="display:none;"></td>
                <td class="qty-single-cell">
                    <input type="number" class="form-control recipe-input qty-single"
                           th:value="${ing.quantity}">
                </td>
                <td>
                    <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>
                    <input type="hidden" class="item-no" th:value="${ing.itemNo}">
                </td>
            </tr>
            </tbody>

        </table>

    </div>

    <div class="text-center mt-3">
        <button class="btn custom-btn" id="saveBtn">저장</button>
        <button class="btn gray-btn" id="cancelBtn">취소</button>
    </div>

</div>

<!-- 모달 -->
<div class="modal fade" id="ingredientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="fw-bold modal-title">재료 불러오기</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">카테고리</label>
                        <select class="form-select" id="modalCategory">
                            <option>전체</option>
                            <option>도우</option>
                            <option>치즈</option>
                            <option>토핑</option>
                            <option>소스</option>
                            <option>향신료</option>
                            <option>야채</option>
                            <option>면</option>
                            <option>사이드</option>
                            <option>음료</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">검색조건</label>
                        <select class="form-select" id="modalSearchType">
                            <option>품목코드</option>
                            <option>재료명</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">검색어</label>
                        <input type="text" class="form-control" id="modalKeyword">
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-dark" id="modalSearchBtn">조회</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover text-center align-middle">
                        <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="checkAll"></th>
                            <th>품목 코드</th>
                            <th>재료 명</th>
                            <th>카테고리</th>
                            <th>기준 단위</th>
                        </tr>
                        </thead>

                        <tbody id="ingredientTableBody"></tbody>
                    </table>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn custom-btn" id="modalAddSelected">선택 재료 등록</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>

        </div>
    </div>
</div>


<script>
    $("#removeImageBtn").click(function () {
        $("#imageArea").hide();
        $("#removeImage").val("true");
        $("#menuImage").val("");
    });
    $("#modalSearchBtn").click(function () {
        let category = $("#modalCategory").val();
        let type = $("#modalSearchType").val();
        let keyword = $("#modalKeyword").val();

        let itemCategory = category === "전체" ? "" : category;
        let ingredientName = type === "재료명" ? keyword : "";
        let itemCode = type === "품목코드" ? keyword : "";

        fetchUtil(
            `/menu/itemList?itemCategory=${itemCategory}&ingredientName=${ingredientName}&itemCode=${itemCode}`,
            data => {
                let html = "";
                data.forEach(row => {
                    html += `
                <tr data-itemno="${row.itemNo}">
                    <td><input type="checkbox" class="row-check"></td>
                    <td>${row.itemCode}</td>
                    <td>${row.ingredientName}</td>
                    <td>${row.category}</td>
                    <td>${row.stockUnit}</td>
                </tr>`;
                });
                $("#ingredientTableBody").html(html);
            }
        );
    });

    // 선택 재료 등록
    $("#modalAddSelected").click(function () {
        let hasSize = $("#hasSize").val() === "true";
        let recipeBody = $("#recipeList");
        let selectedRows = $(".row-check:checked");

        selectedRows.each(function () {
            let row = $(this).closest("tr");
            let itemNo = row.data("itemno");
            let name = row.children().eq(2).text();
            let unit = row.children().eq(4).text();

            let html = "";
            if (hasSize) {
                html =
                    `<tr>
                    <td>${name}</td>
                    <td>${unit}</td>
                    <td class="size-option">
                        <input type="number" class="form-control recipe-input qty-large">
                    </td>
                    <td class="size-option">
                        <input type="number" class="form-control recipe-input qty-medium">
                    </td>
                    <td class="qty-single-cell" style="display:none;"></td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>
                        <input type="hidden" class="item-no" value="${itemNo}">
                    </td>
                </tr>`;
            } else {
                html =
                    `<tr>
                    <td>${name}</td>
                    <td>${unit}</td>
                    <td class="size-option" style="display:none;"></td>
                    <td class="size-option" style="display:none;"></td>
                    <td class="qty-single-cell">
                        <input type="number" class="form-control recipe-input qty-single">
                    </td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm delete-row">삭제</button>
                        <input type="hidden" class="item-no" value="${itemNo}">
                    </td>
                </tr>`;
            }
            recipeBody.append(html);
        });

        $("#ingredientModal").modal("hide");
    });

    $(document).on("click", ".delete-row", function () {
        $(this).closest("tr").remove();
    });

    $("#saveBtn").click(function () {
        var hasSize = $("#hasSize").val() === "true";

        var menuRequest = {};
        menuRequest.menuNo = parseInt($("#baseMenuNo").val(), 10);
        menuRequest.menuName = $("#menuName").val();
        menuRequest.menuCode = $("#menuCode").val();
        menuRequest.menuCategory = $("#menuCategory").val();
        menuRequest.menuExplain = $("#menuExplain").val();
        menuRequest.releaseStatus = $("#releaseStatus").val();
        menuRequest.size = hasSize ? "Y" : "N";

        if (hasSize) {
            $(".price-input").each(function () {
                let size = $(this).data("size");
                let price = parseInt($(this).val(), 10) || 0;

                if (size === "라지") menuRequest.menuPriceLarge = price;
                if (size === "미디움") menuRequest.menuPriceMedium = price;
            });
        } else {
            menuRequest.menuPrice = parseInt($("#priceSingle").val(), 10) || 0;
        }

        let ingredients = [];
        $("#recipeList tr").each(function () {
            let dto = {};
            dto.itemNo = parseInt($(this).find(".item-no").val(), 10) || null;
            dto.ingredientName = $(this).children("td").eq(0).text();
            dto.stockUnit = $(this).children("td").eq(1).text();

            if (hasSize) {
                dto.quantityLarge = $(this).find(".qty-large").val() || null;
                dto.quantityMedium = $(this).find(".qty-medium").val() || null;
            } else {
                dto.quantity = $(this).find(".qty-single").val() || null;
            }
            ingredients.push(dto);
        });

        menuRequest.ingredients = ingredients;
        menuRequest.originImage = $("#originImage").val();
        menuRequest.removeImage = $("#removeImage").val() === "true";

        const formData = new FormData();
        formData.append(
            "menuDTO",
            new Blob([JSON.stringify(menuRequest)], { type: "application/json" })
        );

        const menuImage = $("#menuImage")[0].files[0];

        if(menuImage){
            formData.append("menuImage", menuImage);
        }

        fetchUtil(
            "/menu/setMenu",
            () => {
                alert("메뉴가 저장되었습니다.");
                const menuNo = $("#baseMenuNo").val();
                location.href = `/menu/menuDetailUI?menuNo=${menuNo}`;
            },
            "PUT",
            formData
        );
    });

    // 취소
    $("#cancelBtn").click(function () {
        history.back();
    });

</script>

</body>
</html>
