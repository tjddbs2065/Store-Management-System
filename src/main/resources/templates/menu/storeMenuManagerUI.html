<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>직영점별 판매 메뉴 (본사)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script src="/js/modalStoreSearch.js"></script>

    <style>
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }
        body { background:#f7f7f7; padding-top: 65px !important;}
        .container { max-width:1500px; }
        .scroll-area { height:500px; overflow-y:auto; }
        .scroll-area::-webkit-scrollbar { width:8px; }
        .scroll-area::-webkit-scrollbar-thumb { background:#ced4da; border-radius:4px; }
        .table-fixed-header thead th { position:sticky; top:0; background:#f8f9fa; z-index:10; }
        .custom-btn {
            background-color:#FFEEAA !important;
            border-color:#FFEEAA !important;
            color:#000;
        }
    </style>
</head>

<body class="bg-light">
<header th:insert="fragments/toolBar :: toolBar"></header>
<div class="container py-4">

    <div class="bg-white border rounded p-4">

        <h2 class="fw-bold mb-4">직영점별 판매 메뉴</h2>

        <div class="border rounded p-3 mb-4">

            <div class="row g-3 align-items-end">

                <div class="col-md-2">
                    <label class="form-label">판매 상태</label>
                    <select class="form-select" id="searchStatus">
                        <option value="">전체</option>
                        <option>판매중</option>
                        <option>판매중단</option>
                        <option>품절</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">카테고리</label>
                    <select class="form-select" id="searchCategory">
                        <option value="">전체</option>
                        <option>피자</option>
                        <option>사이드디시</option>
                        <option>음료</option>
                        <option>기타</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">검색조건</label>
                    <select class="form-select" id="searchType">
                        <option value="">직영점</option>
                        <option>메뉴</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <input type="text"
                           id="storeInput"
                           class="form-control"
                           placeholder="여기를 눌러 선택하세요"
                           readonly>
                </div>

                <div class="col-md-2">
                    <button class="btn custom-btn w-100" id="searchBtn">조회</button>
                </div>

            </div>

        </div>


        <div class="text-end pb-1">
            <button class="btn custom-btn" id="statusSetAllBtn">선택 일괄 변경</button>
        </div>

        <div class="scroll-area">
            <table class="table align-middle text-center table-fixed-header">
                <thead class="table-light">
                <tr>
                    <th>직영점</th>
                    <th>메뉴코드</th>
                    <th>메뉴명</th>
                    <th>사이즈</th>
                    <th>가격</th>
                    <th>판매 상태</th>
                    <th>상태 변경</th>
                    <th><input type="checkbox" id="checkAll"></th>
                </tr>
                </thead>

                <tbody id="menuTableBody"></tbody>
            </table>
        </div>

    </div>
</div>

<div class="modal fade" id="statusSetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title fw-bold">판매 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-3">
                    <label class="col-3 fw-semibold">메뉴 명</label>
                    <div class="col">
                        <span id="modalMenuName"
                              class="badge bg-light text-dark border px-3 py-2"></span>
                    </div>
                </div>

                <div class="row mb-2">
                    <label class="col-3 fw-semibold">사이즈</label>
                    <label class="col-3 fw-semibold">판매 상태</label>
                </div>

                <div id="modalSizeArea"></div>

            </div>

            <div class="modal-footer">
                <button class="btn custom-btn" id="saveStatusBtn">저장</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center border border-primary">
            <div class="modal-body">
                <p id="alertMessage" class="fs-5 fw-bold mb-4 text-dark"></p>
                <button class="btn custom-btn px-4" data-bs-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>


<th:block th:replace="fragments/modalStoreSearch :: modalStoreSearch"></th:block>

<script src="/js/util.js"></script>

<script>

    function showAlert(msg){
        $("#alertMessage").text(msg);
        $("#alertModal").modal("show");
    }

    $("#searchType").on("change", function () {
        const type = $(this).val();

        if (type === "메뉴") {
            $("#storeInput")
                .attr("placeholder", "메뉴명을 입력하세요")
                .prop("readonly", false)
                .val("")
                .data("storeno", null);
        } else { // 직영점 (기본)
            $("#storeInput")
                .attr("placeholder", "여기를 눌러 선택하세요")
                .prop("readonly", true)
                .val("")
                .data("storeno", null);
        }
    });

    $("#storeInput").on("click", function () {

        const type = $("#searchType").val();
        if (type === "메뉴") {
            return;
        }

        StoreSearchModal.open(
            $("#storeInput").val(),
            function (storeNo, storeName) {
                $("#storeInput").val(storeName);
                $("#storeInput").data("storeno", storeNo);
            }
        );
    });


    function renderMenuTable(data){

        const tbody = $("#menuTableBody");
        tbody.empty();

        if(!data || data.length === 0){
            tbody.append(`<tr><td colspan="8" class="text-center">데이터가 없습니다.</td></tr>`);
            return;
        }

        data.forEach(group => {
            const items = [...group.items].sort((a,b)=>{
                const order = { "라지":1, "미디움":2, "단일":3 };
                return order[a.size] - order[b.size];
            });

            const rowSpan = items.length;

            items.forEach((item, idx)=>{
                let html = "<tr>";

                if(idx === 0){
                    html += `
                        <td rowspan="${rowSpan}">${group.storeName}</td>
                        <td rowspan="${rowSpan}">${group.menuCode}</td>
                        <td rowspan="${rowSpan}">${group.menuName}</td>
                    `;
                }

                html += `
                    <td>${item.size}</td>
                    <td>${item.menuPrice.toLocaleString()}</td>
                    <td>${item.salesStatus}</td>
                `;

                if(idx === 0){
                    html += `
                        <td rowspan="${rowSpan}">
                            <button class="btn btn-outline-secondary btn-sm statusSetBtn"
                                data-menu="${group.menuName}"
                                data-items="${btoa(encodeURIComponent(JSON.stringify(items)))}">
                                변경
                            </button>
                        </td>
                        <td rowspan="${rowSpan}">
                            <input type="checkbox" class="row-check">
                        </td>
                    `;
                }

                html += "</tr>";
                tbody.append(html);
            });

        });
    }

    function loadMenuTable(){

        const type = $("#searchType").val();
        const salesStatus  = $("#searchStatus").val();
        const menuCategory = $("#searchCategory").val();

        if (type === "" || type === "직영점") {

            const storeNo = $("#storeInput").data("storeno");
            if(!storeNo){
                showAlert("직영점을 선택하세요.");
                return;
            }

            const url =
                `/storeMenu/getStoreMenu` +
                `?storeNo=${storeNo}` +
                `&salesStatus=${salesStatus}` +
                `&menuCategory=${menuCategory}`;

            fetchUtil(url, renderMenuTable);
            return;
        }

        if (type === "메뉴") {

            const menuName = $("#storeInput").val().trim();
            if(menuName === ""){
                showAlert("메뉴명을 입력하세요.");
                return;
            }

            const url =
                `/storeMenu/searchMenu` +
                `?menuName=${menuName}` +
                `&salesStatus=${salesStatus}` +
                `&menuCategory=${menuCategory}`;
            console.log("요청 URL:", url);

            fetchUtil(url, renderMenuTable);
        }
    }

    $("#searchBtn").on("click", loadMenuTable);

    $("#checkAll").on("change", function(){
        $(".row-check").prop("checked", this.checked);
    });

    $(document).on("click", ".statusSetBtn", function(){

        const menuName = $(this).data("menu");
        const items = JSON.parse(decodeURIComponent(atob($(this).data("items"))));

        $("#modalMenuName").text(menuName);

        const area = $("#modalSizeArea").empty();

        items.forEach(item=>{
            area.append(`
                <div class="row mb-2">
                    <label class="col-3 fw-semibold">${item.size}</label>
                    <div class="col">
                        <select class="form-select" data-storemenu="${item.storeMenuNo}">
                            <option ${item.salesStatus==="판매중"?"selected":""}>판매중</option>
                            <option ${item.salesStatus==="판매중단"?"selected":""}>판매중단</option>
                            <option ${item.salesStatus==="품절"?"selected":""}>품절</option>
                        </select>
                    </div>
                </div>
            `);
        });

        $("#statusSetModal").modal("show");
    });


    $(document).on("click", "#statusSetAllBtn", function(){

        const checked = $(".row-check:checked");
        if(checked.length === 0){
            showAlert("선택된 항목이 없습니다.");
            return;
        }

        window.bulkItems = [];

        let total = 0;
        let firstName = null;

        checked.each(function(){
            const row = $(this).closest("tr");
            const encoded = row.find(".statusSetBtn").data("items");
            const items = JSON.parse(decodeURIComponent(atob(encoded)));

            window.bulkItems.push(...items);

            total += items.length;
            if(!firstName) firstName = items[0].menuName;
        });

        $("#modalMenuName").text(`${firstName} 외 ${total - 1}건`);

        $("#modalSizeArea").html(`
            <div class="row mb-2">
                <label class="col-3 fw-semibold">전체</label>
                <div class="col">
                    <select class="form-select" id="bulkStatusSelect">
                        <option>판매중</option>
                        <option>판매중단</option>
                        <option>품절</option>
                    </select>
                </div>
            </div>
        `);

        $("#statusSetModal").modal("show");
    });

    $(document).on("click", "#saveStatusBtn", function(){

        const updates = [];
        const bulkSelect = $("#bulkStatusSelect");

        if(bulkSelect.length > 0){
            const status = bulkSelect.val();

            window.bulkItems.forEach(item=>{
                updates.push({
                    storeMenuNo: item.storeMenuNo,
                    salesStatus: status
                });
            });
        } else {
            $("#modalSizeArea select").each(function(){
                updates.push({
                    storeMenuNo: $(this).data("storemenu"),
                    salesStatus: $(this).val()
                });
            });
        }

        fetchUtil(
            "/storeMenu/updateStatus",
            function(){
                $("#statusSetModal").modal("hide");
                loadMenuTable();
                $("#checkAll, .row-check").prop("checked", false);
            },
            "POST",
            updates
        );
    });

</script>

</body>
</html>
