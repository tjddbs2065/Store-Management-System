<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
                xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>직영점 목록 조회</title>

    <!-- Bootstrap + jQuery -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/util.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=55b8e6a9e27878899b29b23d80c19d82&libraries=services,clusterer,drawing"></script>
    <style>
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }
        body {
            background-color: #e5e5e5;
        }

        .section-box {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
        }

        /* 버튼 색 FFEEAA */
        .btn-custom-yellow {
            background-color: #FFEEAA !important;
            border-color: #FFEEAA !important;
            color: #000 !important;
        }

        .btn-custom-yellow:hover {
            background-color: #F3E292 !important;
        }

        /* 페이지네이션 가운데 정렬 */
        #pagination ul {
            justify-content: center;
        }
        #pagination li {
            cursor: pointer;
        }

    </style>
</head>

<body class="p-3">
<header th:replace="fragments/toolBar :: toolBar"></header>
<div class="border border-secondary" style="max-width:1500px; margin:0 auto; background:#fff;">

    <!-- 제목 -->
    <div class="p-3 fs-3 fw-bold">직영점 목록 조회</div>

    <!-- 검색 UI는 그대로 유지 -->
  <div class="px-3 mb-3">
    <div class="d-flex justify-content-end align-items-end">

      <div class="me-4">
        <label class="fw-semibold me-2">운영 상태</label>
        <select id="storeStatus" class="form-select d-inline-block">
          <option value="all">전체</option>
          <option value="영업중">영업중</option>
          <option value="오픈준비">오픈준비</option>
          <option value="폐업">폐업</option>
        </select>
      </div>

      <div class="me-4">
        <label class="fw-semibold me-2">검색 조건</label>
        <select id="searchType" class="form-select d-inline-block">
          <option value="region">지역</option>
          <option value="storename">직영점명</option>
          <option value="manager">점장명</option>
        </select>
      </div>

      <!-- input -->
      <div>
        <label class="fw-semibold me-2"> </label>
        <input type="text"
               id="searchKeyword"
               class="form-control mb-0"
               placeholder="검색어 입력"
               style="width:180px;">
      </div>

      <!-- button (여기서 me-4 제거) -->
      <div>
        <label class="fw-semibold me-2"> </label>
        <button id="searchBtn" class="btn btn-custom-yellow">
          검색
        </button>
      </div>

    </div>
  </div>


  <!-- 본문 -->
    <div class="px-3 pb-4">
        <div class="section-box">
            <div class="row">

                <!-- 좌측 목록 -->
                <div class="col-7">
                    <table class="table table-hover align-middle" id="storeList">
                        <thead>
                        <tr class="text-center">
                            <th>번호</th>
                            <th>직영점명</th>
                            <th>지역</th>
                            <th>점장명</th>
                            <th>상태</th>
                            <th>상세보기</th>
                        </tr>
                        </thead>
                        <tbody id="storeTable"></tbody>
                    </table>

                    <nav>
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>

                <!-- 우측 지도 -->
                <div class="col-5">
                    <div id="map" style="width:100%; height:500px;">

                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- 상세 모달 -->
<div class="modal fade" id="storeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content shadow-lg">

            <!-- HEADER -->
            <div class="modal-header bg-light">
                <h5 class="fw-bold mb-0">직영점 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">

                <!-- 버튼 영역 -->
                <div class="d-flex gap-2 justify-content-end mb-3" id="managerButtons">
                    <button id="storeStockBtn" class="btn btn-custom-yellow btn-sm" sec:authorize="hasAnyRole('ROLE_MANAGER', 'ROLE_ADMIN')">재고 조회</button>
                    <button id="storeMenuBtn" class="btn btn-custom-yellow btn-sm" sec:authorize="hasAnyRole('ROLE_MANAGER', 'ROLE_ADMIN')">판매 메뉴 조회</button>
                    <button id="salesBtn" class="btn btn-custom-yellow btn-sm" sec:authorize="hasAnyRole('ROLE_MANAGER', 'ROLE_ADMIN')">매출 조회</button>
                </div>

                <div class="row">
                    <!-- LEFT INFORMATION AREA -->
                    <div class="col-md-8">

                        <div class="row g-3">

                            <!-- 매장명 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">직영점</label>
                                <div id="mdStoreName" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 상태 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">매장 상태</label>
                                <div id="mdStatus" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 점장명 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">점장명</label>
                                <div id="mdManagerName" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 점장 연락처 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">점장 연락처</label>
                                <div id="mdManagerPhoneNumber" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 주소 -->
                            <div class="col-md-10">
                                <label class="fw-semibold">직영점 주소</label>
                                <div id="mdAddress" class="p-2 border rounded bg-light"></div>
                            </div>

                            <!-- 매장 연락처 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">직영점 연락처</label>
                                <div id="mdStorePhone" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 개점일 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">개점일</label>
                                <div id="mdOpenDate" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 영업시간 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">영업시간</label>
                                <div id="mdTime" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                            <!-- 폐점일 -->
                            <div class="col-md-6">
                                <label class="fw-semibold">폐점일</label>
                                <div id="mdCloseDate" class="p-2 border rounded bg-light w-75"></div>
                            </div>

                        </div>

                    </div>

                    <!-- RIGHT IMAGE AREA -->
                    <div class="col-md-4">
                        <div class="image-wrapper rounded shadow-sm">
                            <img id="mdStoreImg"
                                 src="https://picsum.photos/500/350"
                                 class="img-fluid rounded"
                                 style="object-fit: cover; width:100%; height:350px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-custom-yellow px-4" data-bs-dismiss="modal">
                    닫기
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    const storeTable = $("#storeList")

    function loadPage(pageNo) {
        const storeStatus = $("#storeStatus").val();
        const searchType = $("#searchType").val();
        const keyword = $("#searchKeyword").val();

        const params = new URLSearchParams();
        params.append("page", pageNo-1);

        if (storeStatus !== "all") {
            params.append("storeStatus", storeStatus);
        }
        if (searchType === "region") params.append("address", keyword);
        if (searchType === "storename") params.append("storeName", keyword);
        if (searchType === "manager") params.append("managerName", keyword);


        fetchUtil(`/getStoreList?${params.toString()}`, data => {
            renderStoreList(data.content);
            updatePaginationUI(pageNo, data.totalPages);
            loadMap(data.content);
        });
    }

    let map;
    const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
    const imageSize = new kakao.maps.Size(24, 35);

    function loadMap(data){
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(37.47984, 126.88279),
            level: 10
        };

        map = new kakao.maps.Map(container, options);
        loadMarkers(data);
    }

    function loadMarkers(data) {

        if (!data) return;

        const positions = data.map(store => ({
            content: `<div>${store.storeName}</div>`,
            latlng: new kakao.maps.LatLng(store.latitude, store.longitude)
        }));

        positions.forEach(pos => {
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

            const marker = new kakao.maps.Marker({
                map: map,
                position: pos.latlng,
                image: markerImage
            });

            const infowindow = new kakao.maps.InfoWindow({
                content: pos.content
            });

            kakao.maps.event.addListener(marker, 'mouseover', () => {
                infowindow.open(map, marker);
            });

            kakao.maps.event.addListener(marker, 'mouseout', () => {
                infowindow.close();
            });
        });
    }

    function renderStoreList(data) {
        const tbody = storeTable.find("tbody");
        tbody.empty();

        data.forEach(storeList => {
            let row = `
                <tr class = "text-center">
                    <td data-storeno="${storeList.storeNo}">
                        ${storeList.storeNo}
                    </td>
                    <td>${storeList.storeName}</td>
                    <td>${storeList.address}</td>
                    <td>${storeList.managerName}</td>
                    <td>${storeList.storeStatus}</td>
                    <td>
                        <button type="button"
                            class="btn btn-sm detailBtn"
                            data-storeno="${storeList.storeNo}">
                            <i class="bi bi-file-earmark-text" style="font-size: 1.3rem;"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        })
    }
    $(window).on("load", function () {
        loadPage(1);
    });
    $("#storeStatus").on("change", function () {
        loadPage(1);
    });
    $("#searchBtn").on("click", function () {
        loadPage(1);
    });

    $(document).on("click", "#pagination .page-link", function (e) {
        e.preventDefault();      // a 태그 기본 동작 막기
        const page = $(this).data("page");
        loadPage(page);          // 원하는 페이지 로드
    });


    $(document).on("click", ".detailBtn", function () {
        const storeNo = $(this).data("storeno");
        fetchUtil(`getStoreDetail/${storeNo}`, data => {
            openStoreDetail(data);
        })
    });

    let currentStore = null;
    function openStoreDetail(store) {
        currentStore = store;
        $("#mdStoreName").text(store.storeName?? "-");
        $("#mdStatus").text(store.storeStatus?? "-");
        $("#mdManagerName").text(store.managerName?? "-");
        $("#mdManagerPhoneNumber").text(store.phoneNumber?? "-");
        $("#mdAddress").text(store.address?? "-");
        $("#mdStorePhone").text(store.storePhoneNumber?? "-");
        $("#mdOpenDate").text(store.openedDate?? "-");
        $("#mdTime").text(store.openTime + " ~ " + store.closeTime?? "-");
        $("#mdCloseDate").text(store.closedDate?? "-");

        new bootstrap.Modal(document.getElementById("storeDetailModal")).show();
    }

    $("#storeStockBtn").on("click", function () {
        const storeNo = currentStore.storeNo;
        const storeName = currentStore.storeName;
        location.href = `/manager/stock/storeItem?storeNo=${storeNo}&storeName=${encodeURIComponent(storeName)}`;
    })

    $("#storeMenuBtn").on("click", function () {
        const storeNo = currentStore.storeNo;
        const storeName = currentStore.storeName;
        location.href = `/manager/storeMenu?storeNo=${storeNo}&storeName=${encodeURIComponent(storeName)}`;
    })

    $("#salesBtn").on("click", function () {
        const storeNo = currentStore.storeNo;
        const storeName = currentStore.storeName;
        location.href = `/manager/salesMain?storeNo=${storeNo}&storeName=${encodeURIComponent(storeName)}`;
    })

</script>

</body>
</html>
