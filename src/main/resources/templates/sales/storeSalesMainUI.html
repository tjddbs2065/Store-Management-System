<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>매출관리 SPA (직영점)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    function loadPage(page){
      loadList(page);
    }
  </script>
  <script src="/js/util.js"></script>

  <style>
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 2000;
    }
    body { background-color: #fdfdfd;      padding-top: 65px !important; }

    .max-1500 { max-width:1500px; margin:0 auto; }
    .kpi-card { background:#fff; border:1px solid #ccc; border-radius:10px; padding:18px; text-align:center; }
    .kpi-title { font-size:14px; }
    .kpi-value { font-size:22px; font-weight:600; }
    .section-box { background:#fff; border:1px solid #ddd; border-radius:10px; padding:20px; }
    .w-150 { width:150px; }
    .w-120 { width:120px; }
    .detailBtn { width:24px; cursor:pointer; }
    #listPage { display:none; }
  </style>
</head>

<body>
<header th:insert="fragments/toolBar :: toolBar"></header>
<div class="p-2 max-1500">


  <div class="mt-3 px-2">
    <div class="d-flex align-items-center mb-2">
      <span class="me-2">보기</span>
      <div class="btn-group">
        <button id="chartBtn" class="btn btn-warning btn-sm">차트</button>
        <button id="listBtn" class="btn btn-outline-secondary btn-sm">목록</button>
      </div>
    </div>
  </div>

  <div id="chartPage">
    <div class="d-flex align-items-center flex-wrap gap-3 mb-3 px-2">
      <div>
        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="day" class="form-check-input">
          <span>일별</span>
        </label>
        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="week" class="form-check-input">
          <span>주별</span>
        </label>
        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="month" class="form-check-input" checked>
          <span>월별</span>
        </label>
        <label class="form-check form-check-inline">
          <input type="radio" name="period" id="year" class="form-check-input">
          <span>연별</span>
        </label>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="fw-semibold">조회기간</span>
        <div id="periodInputs" class="d-flex align-items-center gap-2">
          <input id="startInput" type="month" class="form-control form-control-sm w-150">
          <span>~</span>
          <input id="endInput" type="month" class="form-control form-control-sm w-150">
        </div>
        <button id="getSalesBtn" class="btn btn-primary btn-sm">조회</button>
      </div>
    </div>

    <div class="row g-3 mb-3 px-2">
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">전체 매출</div>
          <div class="kpi-value" id="kpi-totalSales">-</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">총 판매 수량</div>
          <div class="kpi-value" id="kpi-totalMenu">-</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title">평균 단가</div>
          <div class="kpi-value" id="kpi-avgPrice">-</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-title kpi-compare">전주 대비 매출 증가</div>
          <div class="kpi-value" id="kpi-growth">-</div>
        </div>
      </div>
    </div>

    <div class="section-box mx-2 mb-4">
      <h6 class="fw-bold mb-3">전체 매출 추이</h6>
      <canvas id="mainChart" height="90"></canvas>
    </div>
    <div class="row g-3 mb-3 px-2">
      <div class="col-md-6">
        <div class="section-box">
          <h6 class="fw-bold mb-3">최근 30일 지점별 매출 TOP 5</h6>
          <canvas id="storeSalesTop5Chart" height="130"></canvas>
        </div>
      </div>

      <div class="col-md-6">
        <div class="section-box">
          <h6 class="fw-bold mb-3">최근 30일 메뉴별 매출 비중</h6>
          <canvas id="menuCountChart" height="130"></canvas>
        </div>
      </div>
    </div>
  </div>




  <div id="listPage">

    <div class="section-box mx-2 mt-3">
      <h6 class="fw-bold mb-3">직영점 매출 리스트</h6>

      <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
        <span class="fw-semibold">조회기간</span>

        <input type="date" id="list-start" class="form-control form-control-sm w-150">
        <span>~</span>
        <input type="date" id="list-end" class="form-control form-control-sm w-150">


        <button class="btn btn-sm btn-outline-secondary" id="list-searchBtn">검색</button>
      </div>

      <table class="table table-hover align-middle mb-3">
        <thead>
        <tr class="text-center">
          <th>번호</th>
          <th>주문수</th>
          <th>매출액</th>
          <th>판매날짜</th>
          <th></th>
        </tr>
        </thead>
        <tbody id="storeTable"></tbody>
      </table>

      <div class="d-flex justify-content-center mb-3">
        <ul class="pagination pagination-sm" id="pagination"></ul>
      </div>
    </div>

  </div>

</div>

<script>
  $(document).on("click", "#logoutBtn", function () {
    location.href = "/logout";
  });


  $(document).on("change", "#startInput", function () {
    const start = $(this).val();
    $("#endInput").attr("min", start);

    if ($("#endInput").val() && $("#endInput").val() < start) {
      $("#endInput").val(start);
    }
  });

  $(document).on("change", "#endInput", function () {
    const end = $(this).val();
    $("#startInput").attr("max", end);

    if ($("#startInput").val() && $("#startInput").val() > end) {
      $("#startInput").val(end);
    }
  });

  $("#getSalesBtn").on("click", function () {

    const type = $("input[name='period']:checked").attr("id");

    const start = $("#startInput").val();
    const end   = $("#endInput").val();

    if (!start || !end) {
      alert("조회기간을 입력하세요.");
      return;
    }

    loadTrend(type, start, end);
    loadKPI(type, start, end);
  });


  $("#chartBtn").on("click", ()=>showChart());
  $("#listBtn").on("click", ()=>showList());

  function updateModeButtons(mode){
    $("#chartBtn").toggleClass("btn-warning", mode==="chart")
            .toggleClass("btn-outline-secondary", mode!=="chart");
    $("#listBtn").toggleClass("btn-warning", mode==="list")
            .toggleClass("btn-outline-secondary", mode!=="list");
  }

  function showChart(){ $("#chartPage").show(); $("#listPage").hide(); updateModeButtons("chart"); }
  function showList(){ $("#chartPage").hide(); $("#listPage").show(); updateModeButtons("list"); }



  function updatePeriodInputs(type){
    const box = $("#periodInputs");
    const tpl = {
      day:`<input id="startInput" type="date" class="form-control form-control-sm w-150">
           <span>~</span>
           <input id="endInput" type="date" class="form-control form-control-sm w-150">`,
      week:`<input id="startInput" type="week" class="form-control form-control-sm w-150">
            <span>~</span>
            <input id="endInput" type="week" class="form-control form-control-sm w-150">`,
      month:`<input id="startInput" type="month" class="form-control form-control-sm w-150">
             <span>~</span>
             <input id="endInput" type="month" class="form-control form-control-sm w-150">`,
      year:`<input id="startInput" type="number" class="form-control form-control-sm w-120" placeholder="연도">
            <span>~</span>
            <input id="endInput" type="number" class="form-control form-control-sm w-120" placeholder="연도">`
    };
    box.html(tpl[type]);
  }

  $("input[name='period']").on("change", function(){
    updatePeriodInputs($(this).attr("id"));
  });



  let mainChart;

  function createMainChart(labels, values){
    const ctx = $("#mainChart")[0].getContext("2d");
    if(mainChart) mainChart.destroy();

    mainChart = new Chart(ctx,{
      type:"line",
      data:{
        labels,
        datasets:[{
          label:"매출액",
          data:values,
          borderColor:"#007bff",
          backgroundColor:"rgba(0,123,255,0.15)",
          borderWidth:2,
          fill:true
        }]
      }
    });
  }

  function loadTrend(type, start, end){
    fetchUtil(`/store/salesChart?startDate=${start}&endDate=${end}&type=${type}`, data => {
      createMainChart(data.labels, data.values);
    });
  }


  function loadKPI(type, start, end){
    fetchUtil(`/store/KPI?type=${type}&startDate=${start}&endDate=${end}`, data => {
      $("#kpi-totalSales").text(data.totalSales.toLocaleString());
      $("#kpi-totalMenu").text(data.totalMenuCount.toLocaleString());
      $("#kpi-avgPrice").text(data.avgOrderAmount?.toLocaleString() ?? "-");
      $("#kpi-growth").text(data.growthRate.toFixed(1)+"%");
    });
  }


  let top5Chart;

  function loadTop5(){
    fetchUtil("/totalStoreSales", data => {
      const labels = data.map(x=>x.storeName);
      const values = data.map(x=>x.totalSales);

      const ctx = $("#storeSalesTop5Chart")[0].getContext("2d");
      if(top5Chart) top5Chart.destroy();

      top5Chart = new Chart(ctx,{
        type:"bar",
        data:{
          labels,
          datasets:[{
            label:"매출금액",
            data:values,
            backgroundColor:["#0d6efd","#6f42c1","#d63384","#fd7e14","#198754"]
          }]
        },
        options:{ indexAxis:"y" }
      });
    });
  }

  let menuChart;

  function loadMenuRatio(){
    fetchUtil("/menuRatio", data => {

      data.sort((a,b)=>b.salesAmount - a.salesAmount);

      const top5 = data.slice(0,5);
      const rest = data.slice(5);
      const etcTotal = rest.reduce((s,x)=>s+x.salesAmount,0);

      const labels = top5.map(x=>x.menuName);
      const values = top5.map(x=>x.salesAmount);

      if(etcTotal>0){
        labels.push("기타");
        values.push(etcTotal);
      }

      const ctx = $("#menuCountChart")[0].getContext("2d");
      if(menuChart) menuChart.destroy();

      const colors = ["#ff6384","#36a2eb","#ffcd56","#4bc0c0","#9966ff","#c9cbcf"];

      menuChart = new Chart(ctx,{
        type:"doughnut",
        data:{
          labels,
          datasets:[{
            data:values,
            backgroundColor: colors.slice(0, labels.length)
          }]
        },
        plugins:[ChartDataLabels],
        options:{
          plugins:{
            legend:{ display:true },
            datalabels:{
              color:"#000",
              formatter:(value, ctx)=>{
                const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                const pct = (value / total * 100).toFixed(1);
                const label = ctx.chart.data.labels[ctx.dataIndex];
                return label + "\n" + pct + "%";
              }
            }
          }
        }
      });

    });
  }

  let listCurrentPage = 1;

  function loadList(page){
    listCurrentPage = page;

    let start = $("#list-start").val();
    let end   = $("#list-end").val();
    const salesDate = $("#list-salesDate").val();

    // default: 이번 달 1일 ~ 어제
    if(!start || !end){
      const today = new Date();
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      const toDate = d =>
              `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

      start = toDate(monthStart);
      end   = toDate(yesterday);

      $("#list-start").val(start);
      $("#list-end").val(end);
    }

    fetchUtil(`/store/salesList?startDate=${start}&endDate=${end}&salesDate=${salesDate}&page=${page}`, data => {
      renderList(data.list);
      updatePaginationUI(data.currentPage, data.totalPages);
    });
  }

  function renderList(list){
    const tbody = $("#storeTable");
    tbody.empty();

    if(!list || list.length === 0){
      tbody.append(`<tr><td colspan="5" class="text-center">데이터가 없습니다.</td></tr>`);
      return;
    }

    list.forEach((item, index) => {
      const rowNo = (listCurrentPage - 1) * 10 + (index + 1);

      tbody.append(`
        <tr class="text-center">
          <td>${rowNo}</td>
          <td>${item.orderCount.toLocaleString()}</td>
          <td>${item.salesAmount.toLocaleString()}</td>
          <td>${item.salesDate}</td>
          <td>
            <img src="/image/detail.png" class="detailBtn"
                data-store-no="${item.storeNo}"
                data-sales-date="${item.salesDate}">
          </td>
        </tr>
      `);
    });
  }

  $("#list-searchBtn").on("click", () => loadList(1));

  $(document).on("click", ".detailBtn", function(){
    const storeNo = $(this).data("store-no");
    const date    = $(this).data("sales-date");
    location.href = `/salesDetailUI?storeNo=${storeNo}&salesDate=${date}`;
  });



  $(document).ready(function(){

    showChart();
    $("#day").prop("checked", true);
    updatePeriodInputs("day");

    const today = new Date();

    let startObj, endObj;

    if (today.getDate() === 1) {
      const prevLast = new Date(today.getFullYear(), today.getMonth(), 0);
      const prevStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      startObj = prevStart;
      endObj = prevLast;
    } else {
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      startObj = monthStart;
      endObj = yesterday;
    }

    const toDate = d =>
            `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

    const s = toDate(startObj);
    const e = toDate(endObj);

    $("#startInput").val(s);
    $("#endInput").val(e);

    loadTrend("day", s, e);
    loadKPI("day", s, e);
    loadTop5();
    loadMenuRatio();

    $("#list-start").val(s);
    $("#list-end").val(e);
    loadList(1);
  });

</script>

</body>
</html>
