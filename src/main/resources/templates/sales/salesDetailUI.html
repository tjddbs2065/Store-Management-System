<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>직영점 판매상품 목록</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/util.js"></script>

  <style>
    .page-wrapper {
      max-width:1500px;
      margin:auto;
    }
    .w-240 { width:240px; }
  </style>
</head>

<body class="bg-light">

<div class="page-wrapper">

  <h4 class="text-center mb-4 mt-3" th:text="${storeName}"></h4>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button id="btnBack" class="btn btn-warning btn-sm">뒤로가기</button>

    <div class="d-flex gap-2">
      <input id="searchInput" type="text" class="form-control w-240" placeholder="판매상품 검색">
      <button id="searchBtn" class="btn btn-primary">검색</button>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-0">

      <table class="table table-hover mb-0 text-center align-middle">
        <thead class="table-light">
        <tr>
          <th>번호</th>
          <th>카테고리</th>
          <th>판매상품</th>
          <th>사이즈</th>
          <th>판매수량</th>
          <th>매출액</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

    </div>
  </div>

  <div class="d-flex justify-content-center mt-3">
    <nav>
      <ul class="pagination mb-0" id="pagination"></ul>
    </nav>
  </div>

</div>


<script>

  /* URL 파라미터 */
  const params = new URLSearchParams(location.search);
  const storeNo = params.get("storeNo");
  const salesDate = params.get("salesDate");

  $("#btnBack").on("click", () => history.back());

  let detailData = [];
  let filteredData = [];
  let currentPage = 1;
  const rowsPerPage = 10;

  function renderTable() {
    const startIdx = (currentPage - 1) * rowsPerPage;
    const endIdx = startIdx + rowsPerPage;

    const tbody = $("#tableBody");
    tbody.empty();

    filteredData.slice(startIdx, endIdx).forEach((row, idx) => {
      const rowNo = startIdx + idx + 1;

      tbody.append(`
        <tr>
          <td>${rowNo}</td>
          <td>${row.menuCategory}</td>
          <td>${row.menuName}</td>
          <td>${row.size}</td>
          <td>${row.menuCount}</td>
          <td>${row.totalPrice.toLocaleString()}</td>
        </tr>
      `);
    });

    renderPagination();
  }



  function renderPagination() {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    const $pagination = $("#pagination");
    $pagination.empty();

    if (totalPages === 0) return;


    $pagination.append(`
      <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
        <a class="page-link" href="#" onclick="loadPage(${currentPage - 1}); return false;">&lt;</a>
      </li>
    `);


    for (let i = 1; i <= totalPages; i++) {
      $pagination.append(`
        <li class="page-item ${i === currentPage ? "active" : ""}">
          <a class="page-link" href="#" onclick="loadPage(${i}); return false;">${i}</a>
        </li>
      `);
    }

    /* next */
    $pagination.append(`
      <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
        <a class="page-link" href="#" onclick="loadPage(${currentPage + 1}); return false;">&gt;</a>
      </li>
    `);
  }


  function loadPage(page) {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);

    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderTable();
  }


  function applySearch() {
    const keyword = $("#searchInput").val().trim();

    filteredData =
            keyword === ""
                    ? detailData
                    : detailData.filter(d => d.menuName.includes(keyword));

    currentPage = 1;
    renderTable();
  }

  $("#searchBtn").on("click", applySearch);
  $("#searchInput").on("keyup", e => {
    if (e.key === "Enter") applySearch();
  });



  $(document).ready(function() {
    const url = `/salesDetail?storeNo=${storeNo}&salesDate=${salesDate}`;

    fetchUtil(url, data => {
      detailData = data;
      filteredData = detailData;
      renderTable();
    });
  });

</script>

</body>
</html>
