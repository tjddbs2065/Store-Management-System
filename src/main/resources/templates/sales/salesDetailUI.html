<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>직영점 판매상품 목록</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/util.js"></script>

  <style>
    header {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      z-index: 2000;
    }
    body {
      background-color:#fdfdfd;
      padding-top:65px !important;
    }
    .wrapper {
      max-width:1500px;
      margin:auto;
    }
    .w-240 { width:240px; }
    .section-box {
      background:#fff;
      border:1px solid #ddd;
      border-radius:10px;
      padding:20px;
    }
  </style>
</head>

<body class="bg-light">
<header th:insert="fragments/toolBar :: toolBarManager"></header>

<div class="wrapper">

  <h4 class="text-center my-4" th:text="${storeName}"></h4>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button id="btnBack" class="btn btn-warning btn-sm">뒤로가기</button>

    <div class="d-flex gap-2">
      <input id="searchInput" type="text" class="form-control form-control-sm w-240" placeholder="판매상품 검색">
      <button id="searchBtn" class="btn btn-primary btn-sm">검색</button>
    </div>
  </div>

  <div class="section-box">
    <table class="table table-hover text-center align-middle mb-0">
      <thead class="table-light">
      <tr>
        <th>번호</th>
        <th>카테고리</th>
        <th>판매상품</th>
        <th>사이즈</th>
        <th>판매수량</th>
        <th>매출액</th>
      </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div class="d-flex justify-content-center mt-3">
      <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
    </div>
  </div>

</div>

<script>
  $(document).on("click", "#logoutBtn", () => location.href = "/logout");

  const params = new URLSearchParams(location.search);
  const storeNo = params.get("storeNo");
  const salesDate = params.get("salesDate");

  $("#btnBack").on("click", () => history.back());

  let dataAll = [];
  let dataFiltered = [];
  let currentPage = 1;
  const rowsPerPage = 10;

  function loadPage(page){
    const total = Math.ceil(dataFiltered.length / rowsPerPage);
    if(page < 1 || page > total) return;
    currentPage = page;
    renderTable();
  }

  function renderTable(){
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    const tbody = $("#tableBody");
    tbody.empty();

    dataFiltered.slice(start, end).forEach((d, idx) => {
      tbody.append(`
        <tr>
          <td>${start + idx + 1}</td>
          <td>${d.menuCategory}</td>
          <td>${d.menuName}</td>
          <td>${d.size}</td>
          <td>${d.menuCount.toLocaleString()}</td>
          <td>${d.totalPrice.toLocaleString()}</td>
        </tr>
      `);
    });

    updatePaginationUI(currentPage, Math.ceil(dataFiltered.length / rowsPerPage));
  }

  function applySearch(){
    const keyword = $("#searchInput").val().trim();
    dataFiltered = keyword ? dataAll.filter(x => x.menuName.includes(keyword)) : dataAll;
    currentPage = 1;
    renderTable();
  }

  $("#searchBtn").on("click", applySearch);
  $("#searchInput").on("keyup", e => e.key === "Enter" && applySearch());

  $(document).ready(()=>{
    fetchUtil(`/salesDetail?storeNo=${storeNo}&salesDate=${salesDate}`, data => {
      dataAll = data;
      dataFiltered = dataAll;
      renderTable();
    });
  });
</script>

</body>
</html>
